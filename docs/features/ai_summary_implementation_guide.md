# AIサマリー機能 実装ガイド

## 概要

このドキュメントは、AIサマリー機能の実装内容と使用方法を説明します。

## 実装された機能

### 1. 設定画面
- **場所**: IconBarの一番下（歯車アイコン）またはモバイルヘッダー
- **機能**:
  - Gemini APIキーの入力・保存
  - プロンプトのカスタマイズ
  - APIキーの接続テスト
  - 詳細設定（最大トークン数、温度）

### 2. AIサマリーボタン
- **場所**: チャート右上（フローティングボタン）
- **機能**: クリックでAIサマリーを生成

### 3. AIサマリーカード
- **場所**: チャートの下、データテーブルの上
- **機能**:
  - 生成されたサマリーの表示
  - 折りたたみ/展開
  - コピー機能
  - エラー表示

## セットアップ手順

### 1. パッケージのインストール

```bash
npm install
```

### 2. Gemini APIキーの取得

1. [Google AI Studio](https://makersuite.google.com/app/apikey) にアクセス
2. Googleアカウントでログイン
3. 「Create API Key」をクリック
4. APIキーをコピー

### 3. APIキーの設定

1. アプリケーションを起動
2. 左端のIconBarの一番下にある歯車アイコンをクリック（またはモバイルの場合はヘッダーの設定アイコン）
3. 「Gemini APIキー」フィールドにAPIキーを入力
4. 「テスト」ボタンで接続確認
5. 「保存」をクリック

## 使用方法

### AIサマリーの生成

1. チャートデータが表示されている状態で、チャート右上の「AIサマリー」ボタンをクリック
2. 数秒待つと、チャートの下にサマリーが表示されます

### サマリーの操作

- **コピー**: サマリーカード右上のコピーアイコンをクリック
- **折りたたみ/展開**: 折りたたみアイコンをクリック
- **閉じる**: ×アイコンをクリック

## プロンプトのカスタマイズ

設定画面でプロンプトを編集できます。

### 使用可能な変数

- `{{analysisMode}}` - 分析モード名
- `{{sheet}}` - 選択セグメント
- `{{selectedBrands}}` - 選択ブランド（カンマ区切り）
- `{{selectedItem}}` - 選択項目
- `{{chartData}}` - チャートデータ（JSON形式）

### プロンプト例

```
あなたはデータ分析の専門家です。以下のチャートデータを分析して、日本語でサマリーコメントを生成してください。

【分析モード】
{{analysisMode}}

【選択されている項目】
- セグメント: {{sheet}}
- ブランド: {{selectedBrands}}
- 分析項目: {{selectedItem}}

【チャートデータ】
{{chartData}}

【指示】
1. データの主要な傾向を3-5点指摘してください
2. 最大値・最小値や特徴的なポイントを指摘してください
3. データから読み取れる洞察や推奨事項を1-2点提示してください
4. 専門的すぎず、わかりやすい日本語で記述してください
5. 箇条書きではなく、自然な文章形式で記述してください

サマリー:
```

## 技術的な詳細

### 使用しているAPI

- **Gemini API**: `gemini-1.5-flash` モデルを使用
  - 高速で低コスト
  - 日本語対応が優秀

### データフロー

1. ユーザーが「AIサマリー」ボタンをクリック
2. `useAISummary`フックがチャートデータとコンテキストを収集
3. `aiSummaryService`がプロンプトを構築
4. Gemini APIを呼び出し
5. レスポンスをパースしてサマリーカードに表示

### 設定の保存

- 設定は`localStorage`に保存されます
- キー:
  - `ai_summary_api_key` - APIキー
  - `ai_summary_prompt` - プロンプト
  - `ai_summary_max_tokens` - 最大トークン数
  - `ai_summary_temperature` - 温度

## トラブルシューティング

### APIキーが無効です

- APIキーが正しく入力されているか確認
- Google AI StudioでAPIキーが有効か確認
- 「テスト」ボタンで接続確認

### サマリーの生成に失敗しました

- インターネット接続を確認
- APIキーの使用制限を確認
- ブラウザのコンソールでエラーを確認

### サマリーが表示されない

- チャートデータが選択されているか確認
- APIキーが設定されているか確認
- ブラウザのコンソールでエラーを確認

## 今後の拡張案

1. **サマリーの履歴機能** - 過去に生成したサマリーを保存・表示
2. **サマリーのエクスポート** - テキストファイルやPDFとして保存
3. **複数言語対応** - 英語でのサマリー生成
4. **サマリーのカスタマイズ** - 長さや詳細度の選択
5. **キャッシュ機能** - 同じデータの場合は再生成しない

## ファイル構成

```
components/
  ├── AISummaryButton.tsx      # AIフローティングボタン
  ├── AISummaryCard.tsx        # サマリー表示カード
  ├── SettingsModal.tsx         # 設定画面モーダル
  └── ChartArea.tsx            # チャートエリア（統合）

src/
  ├── services/
  │   └── aiSummaryService.ts  # Gemini API統合
  └── hooks/
      ├── useAISummary.ts      # AIサマリー生成フック
      └── useAISettings.ts    # 設定管理フック
```

## 注意事項

- APIキーはクライアントサイドに保存されます（暗号化されていません）
- プロダクション環境では、APIキーをサーバーサイドで管理することを推奨
- Gemini APIの使用制限に注意してください
- 無料枠を超える場合は、課金が発生する可能性があります

