# 過去比較モード 実装サマリー

## 📄 ドキュメント構成

このディレクトリには、過去比較モードの実装に関する3つの主要ドキュメントがあります。

```
docs/
├── HISTORICAL_COMPARISON_REQUIREMENTS.md    ← 📋 要件定義書（全体像）
├── HISTORICAL_MODE1_IMPLEMENTATION.md       ← 🔧 Mode 1実装詳細設計
└── HISTORICAL_COMPARISON_SUMMARY.md         ← 📝 本ドキュメント（サマリー）
```

---

## 🎯 プロジェクト目標

既存のExcel可視化アプリケーションに**過去比較機能**を追加し、複数時点のデータを並列比較できるようにする。

### Before（現状）
```
┌───────────────────────────┐
│ 単一Excelファイル         │
│ ↓                         │
│ 詳細分析モード（14種類）  │
│ - ブランド間比較          │
│ - セグメント間比較        │
└───────────────────────────┘
```

### After（実装後）
```
┌─────────────────────────────────────┐
│ 複数Excelファイル（最大3）          │
│ ↓                                   │
│ グローバルモード選択                │
│ ├─ 詳細分析モード（14種類）★既存   │
│ │  - ブランド間比較                 │
│ │  - セグメント間比較               │
│ └─ 過去比較モード（14種類）★新規   │
│    - 時系列データ比較               │
└─────────────────────────────────────┘
```

---

## 📊 機能概要

### 1. データソース管理（全モード共通）

| 機能 | 説明 | 現状 | 実装後 |
|------|------|------|--------|
| ファイル読み込み | Excelファイルのアップロード | 1ファイル | **最大3ファイル** |
| データソース命名 | 表示名の設定 | - | **自動抽出 + 手動編集** |
| 表示切り替え | グラフへの反映ON/OFF | - | **トグルスイッチ** |

#### データソース命名の自動抽出例
```
ファイル名                → 抽出される名前
BFD_2024_01.xlsx         → 2024年1月
survey_2023_Q4.xlsx      → 2023年Q4
data_202312.xlsx         → 2023年12月
report_Dec2024.xlsx      → 2024年12月
weekly_20240115.xlsx     → 2024年1月15日
```

### 2. グローバルモード

アプリケーション全体に適用される2つのモード：

```
┌─────────────────────────────────────┐
│ [詳細分析] [過去比較] ← タブ切替   │
└─────────────────────────────────────┘
```

| モード | 説明 | ブランド選択 | セグメント選択 | データ系列 |
|--------|------|--------------|----------------|-----------|
| **詳細分析** | 既存実装 | 複数可能 (MA) | 複数可能 (MA) | ブランド/セグメント |
| **過去比較** | 新規実装 | 単一 (SA) | 単一 (SA) | データソース（期間） |

### 3. 過去比較モード - Mode 1（最初の実装）

#### 詳細分析モード - Mode 1（既存）
```
モード名: ファネル分析①（セグメント: X=ファネル①×ブランド）

設定:
  セグメント: 全体 (SA)
  ブランド: ブランドA, B, C (MA)
  
グラフ:
  X軸: FT, FN, FC, FP, FS
  凡例: ブランドA, ブランドB, ブランドC
```

#### 過去比較モード - Mode 1（新規）
```
モード名: ファネル分析①（過去比較: X=ファネル①×期間）

設定:
  分析項目: セグメント (SA) × ブランド (SA)
  セグメント: 全体 (SA)
  ブランド: ブランドA (SA)
  データソース: 2024年1月, 2023年12月, 2023年11月
  
グラフ:
  X軸: FT, FN, FC, FP, FS
  凡例: 2024年1月, 2023年12月, 2023年11月
```

---

## 🏗️ 技術実装概要

### アーキテクチャ

```
┌─────────────────────────────────────────┐
│ UI Layer                                │
│  ├─ GlobalModeTab (新規)                │
│  ├─ DataSourceManager (新規)            │
│  ├─ Sidebar (改修)                      │
│  └─ ChartArea (改修)                    │
└────────────┬────────────────────────────┘
             │
┌────────────▼────────────────────────────┐
│ State Management                        │
│  ├─ useGlobalMode (新規)                │
│  ├─ useMultiDataSource (新規)           │
│  ├─ useAnalysisState (既存)             │
│  └─ useDataManagement (既存)            │
└────────────┬────────────────────────────┘
             │
┌────────────▼────────────────────────────┐
│ Business Logic                          │
│  ├─ transformDataForHistoricalChart (新規) │
│  └─ transformDataForChart (既存)        │
└─────────────────────────────────────────┘
```

### 新規作成ファイル

| ファイル | 役割 | 行数目安 |
|---------|------|----------|
| `src/types/dataSource.ts` | データソース型定義 | 50行 |
| `src/types/globalMode.ts` | グローバルモード型定義 | 30行 |
| `src/hooks/useMultiDataSource.ts` | データソース管理フック | 200行 |
| `src/hooks/useGlobalMode.ts` | グローバルモード管理フック | 50行 |
| `components/GlobalModeTab.tsx` | モード切替タブUI | 80行 |
| `components/DataSourceManager.tsx` | データソース管理UI | 150行 |

### 改修ファイル

| ファイル | 改修内容 | 影響範囲 |
|---------|---------|----------|
| `App.tsx` | フック追加、データフロー分岐 | 中 |
| `Sidebar.tsx` | タブ・データソース管理UI追加 | 小 |
| `utils/dataTransforms.ts` | 過去比較用変換関数追加 | 中 |
| `src/hooks/useCSVExport.ts` | 過去比較対応 | 小 |

---

## 📅 実装スケジュール

### Phase 1: 基盤構築（2-3日）
- [ ] 型定義作成
- [ ] `useMultiDataSource` フック実装
- [ ] `useGlobalMode` フック実装
- [ ] ユニットテスト

### Phase 2: UI コンポーネント（2-3日）
- [ ] `GlobalModeTab` 実装
- [ ] `DataSourceManager` 実装
- [ ] スタイリング調整

### Phase 3: データ変換・統合（3-4日）
- [ ] `transformDataForHistoricalChart` 実装
- [ ] `App.tsx` 改修
- [ ] `Sidebar.tsx` 改修
- [ ] 統合テスト

### Phase 4: テスト・デバッグ（2-3日）
- [ ] E2Eテスト実行
- [ ] バグ修正
- [ ] パフォーマンス確認

### Phase 5: ドキュメント整備（1-2日）
- [ ] README更新
- [ ] CHANGELOG更新
- [ ] 使い方ガイド作成

**合計**: 10-15日

---

## 🧪 テスト戦略

### ユニットテスト
- 各フックの個別機能テスト
- データ変換ロジックのテスト
- 日付抽出パターンのテスト

### 統合テスト
- グローバルモード切り替えの動作確認
- データソース追加/削除/編集の動作確認
- グラフ生成の正確性確認

### E2Eテスト
| ID | シナリオ |
|----|---------|
| E2E-01 | 3ファイルアップロード → 過去比較モード → グラフ表示 |
| E2E-02 | データソース名編集 → 凡例反映確認 |
| E2E-03 | データソースOFF → グラフから系列削除確認 |
| E2E-04 | CSV エクスポート → フォーマット確認 |
| E2E-05 | モード切り替え → 状態保持確認 |

---

## 💡 実装のポイント

### 1. 既存コードの再利用
詳細分析モードの実装を最大限活用：
- `transformDataForChart` のロジックを参考
- `ANALYSIS_MODE_CONFIGS` の構造を踏襲
- 既存のUI コンポーネントを流用

### 2. 拡張性の確保
Mode 1の実装を汎用化し、Mode 2-14への展開を容易に：
- グローバルモード設定の一元管理
- データ変換ロジックの共通化
- UIコンポーネントの再利用

### 3. パフォーマンス考慮
複数ファイル読み込み時の最適化：
- データソースの遅延読み込み
- メモ化による不要な再計算の防止
- LocalStorageへの適切な永続化

### 4. ユーザビリティ
直感的な操作感の実現：
- トグルスイッチによる即座の反映
- インライン編集による名前変更
- ドラッグ&ドロップによるファイル追加

---

## 🎨 UI/UX設計

### サイドバーレイアウト（過去比較モード時）

```
┌─────────────────────────────────┐
│ BFD Analytics              [≡] │
├─────────────────────────────────┤
│ [詳細分析] [過去比較]★         │ ← グローバルモードタブ
├─────────────────────────────────┤
│ 📁 データソース管理            │
│   ○ 2024年1月  [✎] [🗑]        │ ← トグル・編集・削除
│   ○ 2023年12月 [✎] [🗑]        │
│   ● 2023年11月 [✎] [🗑]        │ ← OFF状態
│   [+ ファイル追加] (2/3)        │
├─────────────────────────────────┤
│ 📊 分析モード (SA固定)         │
│   ▼ Mode 1: ファネル分析①      │
├─────────────────────────────────┤
│ 📈 分析項目 (固定)              │
│   ファネル①                     │
├─────────────────────────────────┤
│ 📂 セグメント (SA)              │
│   ▼ 全体                        │
├─────────────────────────────────┤
│ 🏷️ ブランド (SA)                │
│   ▼ ブランドA                   │
├─────────────────────────────────┤
│ 🎨 グラフ設定                   │
│   ...                           │
└─────────────────────────────────┘
```

### グラフ表示例

```
ファネル分析①（過去比較: X=ファネル①×期間）
セグメント: 全体 | ブランド: ブランドA

100% ┤
 80% ┤  ███
 60% ┤  ███ ▓▓▓
 40% ┤  ███ ▓▓▓ ░░░
 20% ┤  ███ ▓▓▓ ░░░
  0% ┼───────────────────────
     FT  FN  FC  FP  FS

凡例:
███ 2024年1月
▓▓▓ 2023年12月
░░░ 2023年11月 (非表示)
```

---

## 📦 必要な依存関係

### 新規追加

```bash
npm install uuid @types/uuid
```

### 既存依存関係（確認）

```json
{
  "react": "19.2.0",
  "typescript": "5.8.2",
  "xlsx": "0.18.5",
  "@dnd-kit/core": "latest",
  "recharts": "3.4.1"
}
```

---

## 🚨 リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| データ整合性の問題 | 高 | ファイル間でシート名・ブランド名が一致しない場合のエラーハンドリング |
| パフォーマンス低下 | 中 | メモ化、遅延読み込み、仮想スクロール |
| LocalStorage容量超過 | 中 | データソース数制限（最大3）、圧縮 |
| 既存機能への影響 | 低 | 詳細分析モードの動作確認、回帰テスト |

---

## ✅ 完了条件

### 機能要件
- [x] 要件定義書作成
- [x] 実装詳細設計書作成
- [ ] 3ファイルまで追加可能
- [ ] 自動命名 + 手動編集可能
- [ ] トグルスイッチで表示/非表示切り替え
- [ ] 過去比較モード - Mode 1 が動作
- [ ] グラフの凡例にデータソース名表示
- [ ] CSV/画像エクスポート対応

### 非機能要件
- [ ] レスポンスタイム 3秒以内（3ファイル読み込み）
- [ ] LocalStorage使用量 5MB以内
- [ ] モバイル対応（レスポンシブUI）
- [ ] エラーハンドリング完備

### ドキュメント
- [ ] README更新
- [ ] CHANGELOG更新
- [ ] 使い方ガイド作成
- [ ] コードコメント充実

---

## 📚 参考資料

### 既存ドキュメント
- [README.md](../README.md) - プロジェクト概要
- [REFACTORING_COMPLETION_REPORT.md](../REFACTORING_COMPLETION_REPORT.md) - リファクタリング報告

### 新規ドキュメント
- [HISTORICAL_COMPARISON_REQUIREMENTS.md](./HISTORICAL_COMPARISON_REQUIREMENTS.md) - 要件定義書（全体）
- [HISTORICAL_MODE1_IMPLEMENTATION.md](./HISTORICAL_MODE1_IMPLEMENTATION.md) - Mode 1実装詳細

---

## 🎯 次のステップ

### 今すぐ開始できること
1. ✅ 要件定義のレビュー（本ドキュメント）
2. 型定義ファイルの作成（Phase 1）
3. `useMultiDataSource` フックの実装（Phase 1）

### 実装順序の推奨
```
Phase 1（基盤） → Phase 2（UI） → Phase 3（統合） → Phase 4（テスト） → Phase 5（ドキュメント）
```

### 最初のマイルストーン
**v3.0.0-alpha.1**: 過去比較モード - Mode 1 の動作確認
- データソース管理機能
- グローバルモード切り替え
- 過去比較モード - Mode 1

---

## 🤝 貢献ガイド

実装時の注意事項：
1. 既存の詳細分析モードに影響を与えないこと
2. 型安全性を確保すること（TypeScript厳格モード）
3. ユニットテストを必ず書くこと
4. コードレビューを実施すること

---

**文書バージョン**: 1.0  
**作成日**: 2025-11-30  
**最終更新日**: 2025-11-30  
**ステータス**: ✅ レビュー完了  
**次のアクション**: Phase 1 実装開始

