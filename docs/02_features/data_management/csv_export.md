# CSV Export Functionality

## 概要

BFD Analyticsは、分析結果をCSV形式でエクスポートする機能を提供しています。この機能により、グラフで表示されているデータを外部のツール（Excel、Google Sheets等）で二次分析することが可能です。

## アクセス方法

CSV出力には2つのアクセス方法があります：

### 1. IconBar（左側アイコンバー）- **推奨**

**位置**: 画面左端のアイコンバー、スクリーンショットアイコンの下

**特徴**:
- サイドバーを閉じていても常にアクセス可能
- ワンクリックで即座にエクスポート
- Download（↓）アイコンで識別

**操作方法**:
1. Downloadアイコンをクリック
2. ブラウザのダウンロードフォルダにCSVファイルが保存される

### 2. Sidebar（サイドバー）

**位置**: サイドバー下部、スクリーンショットボタンの下

**特徴**:
- 緑色の目立つボタン
- 「CSV出力」ラベル付き

**操作方法**:
1. サイドバーの「CSV出力」ボタンをクリック
2. ブラウザのダウンロードフォルダにCSVファイルが保存される

## CSV出力形式

### ファイル名

```
analysis_YYYYMMDDHHMMSS.csv
```

**例**: `analysis_20251205172230.csv`

- タイムスタンプはJST（日本標準時）で生成
- ファイル名の衝突を回避

### ファイル構造

CSVファイルは以下の2つのセクションから構成されます：

#### 1. メタデータセクション

分析条件を記録したヘッダー情報：

```csv
出力日時,2025-12-05 17:22:30
モード,1. ファネル分析①（セグメント×複数ブランド）
X軸,FT（認知あり TOP2）、FW（興味あり TOP2）、FZ（好意あり TOP2）...
データ系列,スターバックス、ドトール、タリーズ
フィルタ,全体

```

**フィールド説明**:
- **出力日時**: CSV生成時刻（JST、+9時間変換済み）
- **モード**: 分析モード番号と名称
- **X軸**: グラフのX軸に表示されている項目（複数の場合は「、」で区切り）
- **データ系列**: グラフの系列（ブランドまたはセグメント）
- **フィルタ**: 固定値として選択されている項目

#### 2. データセクション

実際の数値データ（転置形式）：

```csv
ブランド,FT（認知あり TOP2）,FW（興味あり TOP2）,FZ（好意あり TOP2）...
"スターバックス",85.2,72.3,68.9...
"ドトール",78.5,65.1,61.2...
"タリーズ",71.8,58.4,54.7...
```

**特徴**:
- 1行目: ヘッダー行（項目名またはブランド名）
- 2行目以降: データ行（系列ごと）
- 画面のデータテーブルと同じ並び順
- 数値は小数点以下1桁まで

## 対応モード

### 詳細分析モード（14種類）

すべての詳細分析モード（Mode 1-14）でCSV出力が可能です：

**ファネル分析①**:
- Mode 1: セグメント×複数ブランド
- Mode 2: ブランド×複数セグメント
- Mode 3: 項目×複数ブランド

**ファネル分析②**:
- Mode 4: セグメント×複数ブランド（時系列）
- Mode 5: ブランド×複数セグメント（時系列）
- Mode 6: 項目×複数ブランド（時系列）

**ブランドイメージ分析**:
- Mode 7: セグメント×複数ブランド
- Mode 8: ブランド×複数セグメント

**ブランドパワー分析**:
- Mode 9: セグメント×複数ブランド（現在パワー）
- Mode 10: ブランド×複数セグメント（現在パワー）
- Mode 11: セグメント×複数ブランド（将来性パワー）
- Mode 12: ブランド×複数セグメント（将来性パワー）

**アーキタイプ分析**:
- Mode 13: セグメント×複数ブランド
- Mode 14: ブランド×複数セグメント

### 過去比較モード（9種類）

すべての過去比較モード（Mode 1-9）でCSV出力が可能です：

- Mode 1: ファネル分析①（過去比較）
- Mode 2: ファネル分析②（過去比較）
- Mode 3: ブランドイメージ分析（過去比較）
- Mode 4: ブランドパワー分析①（過去比較）
- Mode 5: ブランドパワー分析②（過去比較）
- Mode 6: アーキタイプ分析（過去比較）
- Mode 7: ファネル分析①（ブランド軸×過去比較）
- Mode 8: ファネル分析②（ブランド軸×過去比較）
- Mode 9: ブランドイメージ分析（ブランド軸×過去比較）

## バリデーション

CSV出力を実行する前に、以下の条件がチェックされます：

### 必須条件

1. **データの存在**
   - 詳細分析モード: Excelファイルが読み込まれている
   - 過去比較モード: 最低1つのデータソースが有効

2. **選択項目の妥当性**
   - FILTER軸: 必ず1つ選択されている
   - SERIES/X_AXIS軸: 最低1つ選択されている

### エラーメッセージ

**データ未読み込み**:
```
エクスポートするデータがありません
```

**セグメント未選択**:
```
セグメントを選択してください
```

**ブランド未選択**:
```
ブランドを選択してください
```

**項目未選択**（Mode 3, 6のみ）:
```
エクスポートする項目を選択してください
```

## 技術仕様

### 実装ファイル

| ファイル | 役割 |
|:---|:---|
| `src/hooks/useCSVExport.ts` | CSV出力ロジックの中核 |
| `components/IconBar.tsx` | IconBarのCSV出力ボタン |
| `components/Sidebar.tsx` | SidebarのCSV出力ボタン |
| `App.tsx` | useCSVExportフックの呼び出し |

### useCSVExportフック

**引数**:
```typescript
useCSVExport(
  data: SheetData,                    // 詳細分析モードのデータ
  analysisMode: AnalysisMode,         // 分析モード
  sheet: string,                      // 選択セグメント
  targetBrand: string,                // 選択ブランド（単一）
  selectedBrands: string[],           // 選択ブランド（複数）
  selectedSegments: string[],         // 選択セグメント（複数）
  selectedItem: string,               // 選択項目
  getBrandName: (brand: string) => string,  // ブランド名取得関数
  globalMode: GlobalMode,             // グローバルモード
  dataSources?: DataSource[],         // 過去比較モードのデータソース
  brandImageData?: BrandImageData     // ブランドイメージデータ
)
```

**戻り値**:
```typescript
{
  exportCSV: () => void  // CSV出力関数
}
```

### 主要機能

#### 1. モード番号取得（getModeNumber）

分析モードから表示用のモード番号を取得：

- 詳細分析モード: 1-14
- 過去比較モード: 1-9

#### 2. メタデータ生成（generateMetadataSection）

CSVファイルのヘッダー部分を生成：

- 出力日時（JST変換済み）
- モード番号と名称
- X軸項目
- データ系列
- フィルタ項目

#### 3. データセクション生成

**詳細分析モード（generateDetailedModeDataSection）**:
- 単一データソースから複数ブランド/セグメントを抽出
- 転置形式で出力（系列が行、項目が列）

**過去比較モード（generateHistoricalModeDataSection）**:
- 複数データソースから単一ブランド/セグメントを抽出
- 転置形式で出力（データソースが行、項目が列）

#### 4. ブランドイメージ項目の動的選定

Mode 7, 8（詳細分析）、Mode 3, 9（過去比較）では：

1. 基準データから全ブランドイメージ項目を取得
2. 値の降順でソート
3. 上位30項目を自動選定
4. CSV出力時に選定された項目のみを含める

### 文字エンコーディング

- **BOM付きUTF-8**: Excelでの文字化けを防止
- CSVの先頭に`\ufeff`（BOM）を挿入

### 日本語対応

- セグメント名、ブランド名、項目名はすべて日本語対応
- ダブルクォートで囲むことで、カンマを含む値も正しく処理

## 使用例

### ケース1: 詳細分析モード - 複数ブランド比較

**シナリオ**: Mode 1で「全体」セグメント、3ブランドのファネル分析

**CSV出力内容**:
```csv
出力日時,2025-12-05 17:30:00
モード,1. ファネル分析①（セグメント×複数ブランド）
X軸,FT（認知あり TOP2）、FW（興味あり TOP2）、FZ（好意あり TOP2）、GC（購入意向あり TOP2）、GJ（購入経験あり TOP5）、GL（リピート意向あり TOP2）
データ系列,スターバックス、ドトール、タリーズ
フィルタ,全体

ブランド,FT（認知あり TOP2）,FW（興味あり TOP2）,...
"スターバックス",85.2,72.3,...
"ドトール",78.5,65.1,...
"タリーズ",71.8,58.4,...
```

### ケース2: 過去比較モード - 時系列推移

**シナリオ**: Mode 1で3つのデータソースの時系列比較

**CSV出力内容**:
```csv
出力日時,2025-12-05 17:30:00
モード,1. ファネル分析①（セグメント、ブランド: X=ファネル①×過去比較）
X軸,FT（認知あり TOP2）、FW（興味あり TOP2）、FZ（好意あり TOP2）、GC（購入意向あり TOP2）、GJ（購入経験あり TOP5）、GL（リピート意向あり TOP2）
データ系列,2023年4月、2024年6月、2025年6月
フィルタ,全体、スターバックス

データソース,FT（認知あり TOP2）,FW（興味あり TOP2）,...
"2023年4月",82.1,69.5,...
"2024年6月",84.3,71.2,...
"2025年6月",85.2,72.3,...
```

## トラブルシューティング

### ダウンロードされない

**症状**: ボタンをクリックしてもファイルがダウンロードされない

**確認事項**:
1. ブラウザのポップアップブロッカーを確認
2. ブラウザのダウンロード設定を確認
3. ディスク容量を確認
4. 開発者コンソールでエラーを確認

### 文字化けする

**症状**: Excelで開くと文字化けする

**解決方法**:
1. Excelでファイルを開く際に「テキストファイルウィザード」を使用
2. 文字コードを「UTF-8」に指定
3. または、Googleスプレッドシートで開いてからExcelに変換

### データが不正確

**症状**: 出力されたデータが画面と一致しない

**確認事項**:
1. 選択条件（セグメント、ブランド、項目）を確認
2. グラフの表示を最新にリフレッシュ
3. 匿名化モード（DEMOモード）の状態を確認

## 更新履歴

| 日付 | 変更内容 |
|:---|:---|
| 2025-12-05 | IconBarへのCSV出力アイコン追加 |
| 2025-12-05 | CSV出力形式の文書化 |
| 2025-12-05 | メタデータセクションの詳細説明追加 |

---

**関連ドキュメント**:
- [仕様書](../../01_overview/specification.md) - UI構成とCSV出力機能の位置
- [CHANGELOG](../../06_changelog/CHANGELOG.md) - 変更履歴
