# AIサマリー機能 実装提案書

## 概要
表示されているチャートデータに対して、AIボタンを押すと自動でサマリーコメントを生成する機能を追加します。

## 機能要件

### 1. UI配置案

#### 案A: ChartArea内に配置（推奨）
- **位置**: チャートタイトルの横、またはチャートの下に配置
- **メリット**: 
  - チャートと密接に関連していることが明確
  - データテーブルの上に配置することで、データ全体のサマリーとして機能
- **実装場所**: `components/ChartArea.tsx`

#### 案B: IconBarに追加
- **位置**: スクリーンショットボタンの下にAIアイコンボタンを追加
- **メリット**: 
  - 既存のUIパターンに統一
  - 常にアクセス可能
- **実装場所**: `components/IconBar.tsx`

#### 案C: チャートの上にフローティングボタン
- **位置**: チャート右上にフローティングアクションボタン
- **メリット**: 
  - 視覚的に目立つ
  - チャートと直接関連付けられる

**採用**: **案C** - チャート右上にフローティングアクションボタンとして配置

### 2. AI実装方法の選択肢

#### オプション1: OpenAI API
- **メリット**: 
  - 高品質なサマリー生成
  - 日本語対応が優秀
  - 実装が簡単
- **デメリット**: 
  - APIキーが必要
  - コストが発生（ただし、サマリー生成は低コスト）
- **必要なパッケージ**: `openai` または直接fetch

#### オプション2: Google Gemini API（採用）
- **メリット**: 
  - 無料枠が大きい
  - 日本語対応が良い
- **デメリット**: 
  - APIキーが必要
- **必要なパッケージ**: `@google/generative-ai`

#### オプション3: ブラウザ内LLM（Transformers.js）
- **メリット**: 
  - APIキー不要
  - プライバシー保護
  - コストなし
- **デメリット**: 
  - モデルサイズが大きい（初回ダウンロード）
  - 処理速度が遅い可能性
  - 日本語対応が限定的
- **必要なパッケージ**: `@xenova/transformers`

#### オプション4: ローカルルールベース + テンプレート
- **メリット**: 
  - 外部依存なし
  - 高速
  - コストなし
- **デメリット**: 
  - 柔軟性が低い
  - 自然な文章生成が難しい

**採用**: **オプション2（Gemini API）** - 無料枠が大きく、日本語対応が優秀

### 3. サマリー内容の設計

#### 基本構造
1. **データの概要**
   - 分析モード名
   - 選択されているブランド/セグメント
   - データソース（過去比較モードの場合）

2. **主要な傾向**
   - 最大値・最小値の指摘
   - ブランド間の比較（複数ブランド選択時）
   - 時系列の変化（過去比較モード）
   - 特徴的なポイント

3. **洞察と推奨**
   - データから読み取れる示唆
   - 注意すべきポイント

#### モード別のサマリー例

**ファネル分析①の場合:**
```
【ファネル分析①のサマリー】
選択セグメント: [セグメント名]
選択ブランド: [ブランド名]

主要な傾向:
- 認知（FT）が最も高く、[値]%を記録
- 購入検討（FC）は[値]%で、認知から[値]ポイント低下
- ファネル全体の転換率は[値]%

洞察:
- [ブランド名]は認知段階では高いが、購入検討段階で低下傾向
- [項目名]が特に高い（[値]%）ため、この強みを活かす施策が有効
```

**過去比較モードの場合:**
```
【過去比較分析のサマリー】
データソース: [ソース1], [ソース2], [ソース3]
選択セグメント: [セグメント名]
選択ブランド: [ブランド名]

時系列の変化:
- [項目名]は[ソース1]の[値]%から[ソース3]の[値]%へ[増加/減少]
- 最も変化が大きいのは[項目名]（[変化量]ポイント）

洞察:
- 全体的に[上昇/下降]傾向が見られる
- [項目名]の改善が顕著で、[推奨事項]
```

### 4. データ準備

#### AIに渡すデータ構造
```typescript
interface AISummaryRequest {
  // チャートデータ
  chartData: ChartDataPoint[];
  
  // 分析コンテキスト
  context: {
    globalMode: GlobalMode;
    analysisMode: AnalysisMode;
    chartType: ChartType;
    sheet: string;
    targetBrand: string;
    selectedBrands: string[];
    selectedSegments: string[];
    selectedItem: string;
    dataSources?: DataSource[];
  };
  
  // メタデータ
  metadata: {
    modeConfig: AnalysisModeConfig;
    itemLabels: Record<string, string>;
    brandNames: Record<string, string>;
  };
}
```

### 5. UI/UX設計

#### AIボタン（フローティングボタン）
- **位置**: チャート右上にフローティング配置
- **アイコン**: `Sparkles` または `Brain` (lucide-react)
- **スタイル**: 
  - 固定位置（position: absolute）
  - 影付きカードスタイル
  - 角丸
- **状態**: 
  - 通常: インディゴ背景、白アイコン
  - ホバー: インディゴ600に変化
  - ローディング: スピナーアニメーション
  - エラー: 赤色

#### サマリー表示エリア
- **位置**: チャートの下、データテーブルの上
- **表示形式**: 
  - 折りたたみ可能なカード
  - デフォルトで展開
  - コピーボタン付き
- **スタイル**: 
  - 背景: インディゴ50（薄い青）
  - ボーダー: インディゴ200
  - テキスト: グレー800

#### ローディング状態
- スケルトンローディングまたはスピナー
- 「AIがサマリーを生成中...」というメッセージ

#### エラーハンドリング
- APIエラーの場合: 「サマリーの生成に失敗しました。もう一度お試しください。」
- データがない場合: ボタンを無効化

### 6. 実装の詳細

#### コンポーネント構造
```
components/
  ├── AISummaryButton.tsx      # AIフローティングボタンコンポーネント
  ├── AISummaryCard.tsx        # サマリー表示カード
  ├── SettingsModal.tsx        # 設定画面モーダル
  └── hooks/
      └── useAISummary.ts       # AIサマリー生成フック
services/
  └── aiSummaryService.ts       # Gemini API統合サービス
```

#### フック設計（useAISummary.ts）
```typescript
interface UseAISummaryOptions {
  chartData: ChartDataPoint[];
  context: AISummaryContext;
  metadata: AISummaryMetadata;
}

interface UseAISummaryReturn {
  summary: string | null;
  isLoading: boolean;
  error: string | null;
  generateSummary: () => Promise<void>;
  clearSummary: () => void;
}

export const useAISummary = (options: UseAISummaryOptions): UseAISummaryReturn => {
  // 実装
};
```

#### API呼び出し設計
```typescript
// services/aiSummaryService.ts
export const generateAISummary = async (
  request: AISummaryRequest
): Promise<string> => {
  // OpenAI APIまたはGemini APIを呼び出し
  // プロンプトを構築して送信
  // レスポンスをパースして返す
};
```

#### プロンプト設計
- **設定画面からカスタマイズ可能**
- **デフォルトプロンプト**:
```typescript
const DEFAULT_PROMPT = `
あなたはデータ分析の専門家です。以下のチャートデータを分析して、日本語でサマリーコメントを生成してください。

【分析モード】
{{analysisMode}}

【選択されている項目】
- セグメント: {{sheet}}
- ブランド: {{selectedBrands}}
- 分析項目: {{selectedItem}}

【チャートデータ】
{{chartData}}

【指示】
1. データの主要な傾向を3-5点指摘してください
2. 最大値・最小値や特徴的なポイントを指摘してください
3. データから読み取れる洞察や推奨事項を1-2点提示してください
4. 専門的すぎず、わかりやすい日本語で記述してください
5. 箇条書きではなく、自然な文章形式で記述してください

サマリー:
`;
```

**プロンプト変数**:
- `{{analysisMode}}` - 分析モード名
- `{{sheet}}` - 選択セグメント
- `{{selectedBrands}}` - 選択ブランド（カンマ区切り）
- `{{selectedItem}}` - 選択項目
- `{{chartData}}` - チャートデータ（JSON形式）

### 7. セキュリティとプライバシー

#### APIキー管理
- **設定画面からユーザーが入力**
- localStorageに暗号化して保存（オプション）
- クライアントサイドから直接Gemini APIを呼び出す
- APIキーは設定画面でのみ表示（マスク表示）

#### データ送信
- 必要最小限のデータのみ送信
- 匿名化モードがONの場合は、ブランド名を匿名化してから送信

### 8. 設定画面の設計

#### 設定項目
1. **Gemini APIキー**
   - 入力フィールド（パスワードタイプ）
   - 保存ボタン
   - テスト接続ボタン

2. **プロンプト設定**
   - テキストエリア（複数行）
   - 変数一覧の表示
   - デフォルトに戻すボタン
   - プレビュー機能

3. **その他の設定**
   - サマリーの最大文字数
   - タイムアウト時間

#### 設定画面への導線
- **IconBarの一番下に歯車アイコンを配置**
- クリックでモーダルを開く
- 設定はlocalStorageに保存

### 9. 実装ステップ

1. **Phase 1: 基本実装**
   - 設定画面モーダルの作成
   - IconBarに歯車アイコン追加
   - Gemini API統合サービス作成
   - AIフローティングボタンの作成
   - サマリー表示カードの作成
   - useAISummaryフックの実装

2. **Phase 2: UI/UX改善**
   - ローディング状態の改善
   - エラーハンドリングの強化
   - アニメーション追加
   - プロンプトプレビュー機能

3. **Phase 3: 最適化**
   - プロンプトの最適化
   - キャッシュ機能（同じデータの場合は再生成しない）
   - レート制限の実装
   - APIキーの暗号化（オプション）

### 10. 技術的な考慮事項

#### パフォーマンス
- API呼び出しは非同期で実行
- タイムアウト設定（30秒）
- リトライロジック（最大3回）

#### コスト管理
- トークン数の制限
- 使用量の監視
- 無料枠の活用

#### アクセシビリティ
- キーボード操作対応
- スクリーンリーダー対応
- ARIAラベルの追加

### 11. 今後の拡張案

1. **サマリーのカスタマイズ**
   - ユーザーがサマリーの長さや詳細度を選択可能

2. **サマリーの保存**
   - 生成したサマリーをローカルストレージに保存
   - エクスポート機能（テキスト、PDF）

3. **多言語対応**
   - 英語でのサマリー生成オプション

4. **比較モード**
   - 複数のサマリーを並べて比較

5. **履歴機能**
   - 過去に生成したサマリーの履歴表示

## 採用実装アプローチ

1. **UI配置**: 案C（チャート右上にフローティングボタン）
2. **AI実装**: Gemini API（設定画面からAPIキー入力）
3. **表示形式**: 折りたたみ可能なカード（チャートの下）
4. **設定画面**: IconBarの一番下に歯車アイコンで開く
5. **プロンプト**: 設定画面からカスタマイズ可能
6. **初期実装**: Phase 1のみ（基本機能）

## 注意事項

- APIキーは環境変数で管理し、Gitにコミットしない
- エラーハンドリングを適切に実装
- ユーザーにAPIキーの設定方法を案内する必要がある場合がある
- 無料枠を超える場合は、ユーザーに通知する仕組みを検討

