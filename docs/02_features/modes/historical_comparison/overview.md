# 過去比較モード 要件定義書

## 📋 概要

既存の「詳細分析モード」に加えて、「過去比較モード」を新設し、複数の時系列データを比較分析できるようにする。

---

## 🎯 目的

- 同一ブランド・同一セグメントにおける時系列変化の可視化
- 複数期間のデータを並列比較することで、トレンドや変化を把握
- 既存の14種類の分析モードを過去比較版として展開

---

## 🔄 グローバルモードの概念

### モード構成

```
グローバルモード (タブ切り替え)
├── 詳細分析モード (既存実装)
│   ├── Mode 1-14: セグメント間/ブランド間比較
│   └── 特徴: 単一時点での複数ブランド/セグメント比較
└── 過去比較モード (新規実装) ★
    ├── Mode 1-14: 時系列比較
    └── 特徴: 単一ブランド/セグメントの複数時点比較
```

### UI配置

**サイドバー上部にタブを追加**
```
┌─────────────────────────────┐
│ [詳細分析] [過去比較] ← タブ │
├─────────────────────────────┤
│ データソース管理           │
│ （過去比較モード時のみ表示） │
├─────────────────────────────┤
│ 分析モード選択              │
├─────────────────────────────┤
│ セグメント選択              │
├─────────────────────────────┤
│ ブランド選択                │
└─────────────────────────────┘
```

---

## 📦 データソース管理（全モード共通）

### 1. 複数ファイル読み込み機能

#### 仕様
- **最大ファイル数**: 3ファイル
- **現行**: 1ファイル → **拡張**: 3ファイル
- **ファイル形式**: .xlsx, .xls, .csv（既存と同じ）

#### データ構造の拡張
```typescript
// 現行
type DataStructure = Record<string, Record<string, Metrics>>;
const data: DataStructure;

// 拡張後
type DataSource = {
  id: string;                    // 一意識別子 (uuid)
  name: string;                  // 表示名
  fileName: string;              // 元ファイル名
  uploadedAt: Date;              // アップロード日時
  data: DataStructure;           // 実データ
  brandImageData?: Record<string, BrandImageData>;
  isActive: boolean;             // グラフ表示ON/OFF
};

type MultiDataSourceState = {
  dataSources: DataSource[];     // 最大3つ
  currentSourceId: string | null; // 詳細分析モードで使用中のID
};
```

### 2. データソース命名機能

#### 自動命名ルール
ファイル名から年月情報を抽出して自動設定（正規表現）

**パターン例**:
```
ファイル名 → 自動抽出名
----------------------------------
BFD_2024_01.xlsx      → 2024年1月
survey_2023_Q4.xlsx   → 2023年Q4
data_202312.xlsx      → 2023年12月
report_Dec2024.xlsx   → 2024年12月
weekly_20240115.xlsx  → 2024年1月15日
```

**正規表現パターン**:
```typescript
const patterns = [
  /(\d{4})[_-](\d{1,2})/,           // YYYY_MM, YYYY-MM
  /(\d{4})[_-]?Q([1-4])/i,          // YYYY_Q1, YYYYQ2
  /(\d{4})(\d{2})/,                 // YYYYMM
  /(Jan|Feb|Mar|...|Dec)(\d{4})/i,  // MonYYYY
  /(\d{4})[_-]?(\d{2})[_-]?(\d{2})/ // YYYY_MM_DD, YYYYMMDD
];
```

**フォールバック**:
- パターンマッチしない場合: `データ1`, `データ2`, `データ3`

#### 手動編集機能
- 各データソースの名前を自由に編集可能
- 編集UI: インライン編集（鉛筆アイコンクリック）
- 文字数制限: 最大20文字

### 3. データソース表示/非表示切り替え

#### トグルスイッチ
```
┌─────────────────────────────────┐
│ データソース管理               │
├─────────────────────────────────┤
│ ○ 2024年1月  [編集] [削除]     │ ← ON
│ ● 2023年12月 [編集] [削除]     │ ← OFF
│ ○ 2023年11月 [編集] [削除]     │ ← ON
├─────────────────────────────────┤
│ [+ ファイル追加] (0/3)          │
└─────────────────────────────────┘
```

#### 仕様
- **トグル状態**: グラフ・データテーブルへの反映ON/OFF
- **制約**: 最低1つはONが必要（全OFF禁止）
- **保存**: LocalStorageに永続化

---

## 🆕 過去比較モードの仕様

### 1. 基本コンセプト

#### 詳細分析モードとの違い

| 項目 | 詳細分析モード | 過去比較モード |
|------|--------------|--------------|
| **比較軸** | ブランド間/セグメント間 | 時系列データ |
| **データソース** | 1ファイル | 最大3ファイル |
| **ブランド選択** | 複数選択可能 | 単一選択 (SA) |
| **セグメント選択** | 複数選択可能 | 単一選択 (SA) |
| **データ系列** | 複数ブランド/セグメント | 複数時点データ |
| **凡例表示** | ブランド名/セグメント名 | データソース名 |

#### 具体例

**詳細分析モード - Mode 1**
```
モード名: ファネル分析①（セグメント: X=ファネル①×ブランド）
分析項目: セグメント（SA）
X軸: ファネル① (FT, FN, FC, FP, FS)
データ系列: ブランドA, ブランドB, ブランドC（複数）
```

**過去比較モード - Mode 1**
```
モード名: ファネル分析①（過去比較: X=ファネル①×期間）
分析項目: セグメント（SA）×ブランド（SA）
X軸: ファネル① (FT, FN, FC, FP, FS)
データ系列: 2024年1月, 2023年12月, 2023年11月（複数時点）
```

### 2. UI/UX設計

#### サイドバー構成（過去比較モード選択時）

```
┌─────────────────────────────────┐
│ [詳細分析] [過去比較] ★        │
├─────────────────────────────────┤
│ 📁 データソース管理            │
│   ○ 2024年1月  [編集] [削除]   │
│   ○ 2023年12月 [編集] [削除]   │
│   ● 2023年11月 [編集] [削除]   │ ← OFF
│   [+ ファイル追加] (2/3)        │
├─────────────────────────────────┤
│ 📊 分析モード                   │
│   [Mode 1-14 選択]    (SA固定) │
├─────────────────────────────────┤
│ 📈 分析項目                     │
│   [ファネル①選択など]  (固定)    │
├─────────────────────────────────┤
│ 📂 セグメント                   │
│   [セグメント選択]    (SA)     │
├─────────────────────────────────┤
│ 🏷️ ブランド                     │
│   [ブランド選択]      (SA)     │
├─────────────────────────────────┤
│ 🎨 グラフ設定                   │
│   ...                           │
└─────────────────────────────────┘
```

#### 選択制約

| UI要素 | 詳細分析モード | 過去比較モード |
|--------|--------------|--------------|
| データソース | 1つ（暗黙） | 最大3つ（明示） |
| セグメント | SA or MA | SA（単一） |
| ブランド | SA or MA | SA（単一） |
| 分析項目 | SA or 固定 | SA or 固定（同じ） |

### 3. データ変換ロジック

#### グラフデータ生成

**詳細分析モード（現行）**
```typescript
// 例: Mode 1
chartData = {
  categories: ['FT', 'FN', 'FC', 'FP', 'FS'],
  series: [
    { name: 'ブランドA', data: [45, 30, 20, 15, 10] },
    { name: 'ブランドB', data: [50, 35, 25, 18, 12] },
    { name: 'ブランドC', data: [40, 28, 18, 12, 8] }
  ]
}
```

**過去比較モード（新規）**
```typescript
// 例: Mode 1, セグメント=全体, ブランド=ブランドA
chartData = {
  categories: ['FT', 'FN', 'FC', 'FP', 'FS'],
  series: [
    { name: '2024年1月', data: [45, 30, 20, 15, 10] },
    { name: '2023年12月', data: [43, 28, 19, 14, 9] },
    { name: '2023年11月', data: [40, 26, 17, 12, 8] }
  ]
}
```

#### 実装イメージ

```typescript
function transformDataForHistoricalComparison(
  dataSources: DataSource[],
  selectedSegment: string,
  selectedBrand: string,
  analysisConfig: AnalysisConfig
): ChartData {
  const activeSources = dataSources.filter(ds => ds.isActive);
  
  return {
    categories: getXAxisCategories(analysisConfig),
    series: activeSources.map(source => ({
      name: source.name,
      data: extractMetricsData(
        source.data,
        selectedSegment,
        selectedBrand,
        analysisConfig
      )
    }))
  };
}
```

---

## 🛠️ 技術実装計画

### Phase 1: データソース管理機能（基盤）

#### 1.1 型定義の拡張
- `src/types/dataSource.ts` 新規作成
- `DataSource`, `MultiDataSourceState` 型定義

#### 1.2 状態管理フックの作成
- `src/hooks/useMultiDataSource.ts` 新規作成
  - `addDataSource(file: File): Promise<DataSource>`
  - `removeDataSource(id: string): void`
  - `updateDataSourceName(id: string, name: string): void`
  - `toggleDataSourceActive(id: string): void`
  - `extractDateFromFilename(filename: string): string`

#### 1.3 UI コンポーネント
- `components/DataSourceManager.tsx` 新規作成
  - ファイル追加ボタン
  - データソースリスト
  - トグルスイッチ
  - 編集/削除ボタン

### Phase 2: グローバルモード切り替え

#### 2.1 グローバルモード状態管理
- `src/hooks/useGlobalMode.ts` 新規作成
  - `globalMode: 'detailed' | 'historical'`
  - `setGlobalMode(mode): void`

#### 2.2 UI切り替え
- `components/Sidebar.tsx` の改修
  - タブUI追加
  - グローバルモードに応じた表示切り替え

#### 2.3 分析状態の調整
- `src/hooks/useAnalysisState.ts` の改修
  - グローバルモードに応じて選択制約を変更
  - 過去比較モード時: ブランド・セグメントをSAに制限

### Phase 3: 過去比較モード実装

#### 3.1 データ変換ロジック
- `utils/dataTransforms.ts` の拡張
  - `transformDataForHistoricalComparison()` 追加
  - 既存の `transformDataForChart()` と共存

#### 3.2 チャート表示の調整
- `components/ChartArea.tsx` の改修
  - グローバルモードに応じたデータ取得先の切り替え
  - 凡例表示の調整（データソース名表示）

#### 3.3 データテーブルの調整
- 表側（左側）にデータソース名を表示
- 表頭（上側）にX軸カテゴリを表示

### Phase 4: CSV/画像エクスポート対応

#### 4.1 CSV エクスポート
- `src/hooks/useCSVExport.ts` の改修
  - 過去比較モード対応

#### 4.2 画像エクスポート
- 凡例にデータソース名が表示されることを確認

---

## 🎨 実装優先順位

### 高優先度 (P0)
1. ✅ 要件定義書作成（本ドキュメント）
2. データソース管理機能の実装
3. グローバルモード切り替え機能
4. 過去比較モード - Mode 1 の実装

### 中優先度 (P1)
5. 過去比較モード - Mode 2-14 の実装
6. CSV/画像エクスポート対応
7. エラーハンドリング強化

### 低優先度 (P2)
8. データソース比較表示（3つ並列）
9. パフォーマンス最適化
10. ドキュメント整備

---

## 📐 過去比較モード - Mode 1 詳細仕様

### モード概要

**モード名**: ファネル分析①（過去比較: X=ファネル①×期間）

### 分析軸の構成

| 軸 | 役割 | 値 | 選択方式 |
|----|------|-----|---------|
| **分析項目** | FILTER | ファネル① | 固定 |
| **セグメント** | FILTER | セグメント名 | SA（単一選択） |
| **ブランド** | FILTER | ブランド名 | SA（単一選択） |
| **X軸** | X_AXIS | FT, FN, FC, FP, FS | 固定 |
| **データ系列** | SERIES | データソース（期間） | 複数（最大3） |

### UI イメージ

```
┌─────────────────────────────────┐
│ 📁 データソース管理            │
│   ○ 2024年1月                   │
│   ○ 2023年12月                  │
│   ○ 2023年11月                  │
├─────────────────────────────────┤
│ 📊 分析モード: Mode 1 (固定)   │
├─────────────────────────────────┤
│ 📂 セグメント (SA)              │
│   ▼ 全体                        │
├─────────────────────────────────┤
│ 🏷️ ブランド (SA)                │
│   ▼ ブランドA                   │
├─────────────────────────────────┤
│ 📈 分析項目: ファネル① (固定)  │
└─────────────────────────────────┘
```

### グラフ出力例

**棒グラフ（デフォルト）**
```
100% ┤
 80% ┤ ███ ▓▓▓ ░░░
 60% ┤ ███ ▓▓▓ ░░░
 40% ┤ ███ ▓▓▓ ░░░
 20% ┤ ███ ▓▓▓ ░░░
  0% ┼────────────────
     FT  FN  FC  FP  FS

凡例: ███ 2024年1月  ▓▓▓ 2023年12月  ░░░ 2023年11月
```

### データテーブル出力例

```
┌────────────┬────┬────┬────┬────┬────┐
│            │ FT │ FN │ FC │ FP │ FS │
├────────────┼────┼────┼────┼────┼────┤
│ 2024年1月  │ 45 │ 30 │ 20 │ 15 │ 10 │
│ 2023年12月 │ 43 │ 28 │ 19 │ 14 │  9 │
│ 2023年11月 │ 40 │ 26 │ 17 │ 12 │  8 │
└────────────┴────┴────┴────┴────┴────┘
```

### CSV エクスポート形式

```csv
セグメント,ブランド,データソース,FT,FN,FC,FP,FS
全体,ブランドA,2024年1月,45,30,20,15,10
全体,ブランドA,2023年12月,43,28,19,14,9
全体,ブランドA,2023年11月,40,26,17,12,8
```

---

## 🧪 テストケース

### データソース管理

| ID | テストケース | 期待結果 |
|----|-------------|---------|
| DS-01 | ファイル1つ追加 | 正常追加、自動命名 |
| DS-02 | ファイル3つ追加 | 正常追加 |
| DS-03 | ファイル4つ目追加試行 | エラー表示 |
| DS-04 | データソース名編集 | 正常更新 |
| DS-05 | データソース削除 | 正常削除 |
| DS-06 | 全データソースOFF試行 | エラー表示 |

### 過去比較モード

| ID | テストケース | 期待結果 |
|----|-------------|---------|
| HC-01 | 過去比較モード切り替え | UI変更、SA制限適用 |
| HC-02 | Mode 1でグラフ生成 | 凡例にデータソース名 |
| HC-03 | データソースOFF切り替え | グラフから該当系列削除 |
| HC-04 | CSV エクスポート | 正しいフォーマット |

---

## 📝 備考

### 将来拡張案

1. **データソース数の拡張**: 3→5個まで
2. **期間自動認識の強化**: より柔軟なパターンマッチング
3. **差分表示機能**: 前期比の自動計算・表示
4. **トレンド分析**: 回帰直線・予測値の表示
5. **アニメーション**: 時系列データの動的表示

### 技術的課題

1. **パフォーマンス**: 3ファイル同時読み込み時のメモリ管理
2. **データ整合性**: 異なるファイル間でのシート名・ブランド名の不一致対応
3. **UI/UX**: 限られたスペースでの3データソース管理

### 制約事項

1. **ファイルサイズ**: 1ファイル最大10MB（既存と同じ）
2. **データ構造**: 既存Excelフォーマットに準拠
3. **ブラウザ対応**: Chrome, Edge, Safari最新版

---

## ✅ 完了条件

### Phase 1 完了条件
- [ ] 3ファイルまで追加可能
- [ ] ファイル名から期間名を自動抽出
- [ ] データソース名を手動編集可能
- [ ] トグルスイッチで表示/非表示切り替え
- [ ] LocalStorageに永続化

### Phase 2 完了条件
- [ ] グローバルモードタブが動作
- [ ] 過去比較モード時にUI制約適用
- [ ] 詳細分析モードとの切り替えが正常

### Phase 3 完了条件
- [ ] 過去比較モード - Mode 1 が動作
- [ ] グラフの凡例にデータソース名表示
- [ ] データテーブルの表側にデータソース名表示
- [ ] モード切り替え時にグラフが正しく更新

### Phase 4 完了条件
- [ ] CSV エクスポートが過去比較対応
- [ ] 画像エクスポートが過去比較対応
- [ ] エラーハンドリングが完備

---

**文書バージョン**: 1.0  
**作成日**: 2025-11-30  
**最終更新日**: 2025-11-30  
**ステータス**: ✅ レビュー完了

