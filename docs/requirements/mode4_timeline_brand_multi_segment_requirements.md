# モード4 - ファネル分析②（ブランド×複数セグメント）要件定義書

## 最終更新
2025-11-29

---

## 1. 概要

### 1.1 モード名
**モード4**: ファネル分析②（ブランド: X=ファネル②×セグメント）

### 1.2 モードID
`timeline_brand_multi_segment`

### 1.3 目的
特定のブランドにおいて、複数のセグメント間で**時系列指標（T1-T5）**を比較し、セグメント別の購入・利用時期の違いを評価する。

### 1.4 参照モード
**モード2**（`brand_x_multi_segment`）: ファネル分析①（ブランド固定×複数セグメント）

### 1.5 ファネル①とファネル②の違い
| 項目 | ファネル①（モード1～3） | ファネル②（モード4～6） |
|------|----------------------|----------------------|
| **指標種別** | ファネル指標（FT～GL） | 時系列指標（T1～T5） |
| **分析対象** | 認知から購入までの段階 | 購入・利用の時期 |
| **指標数** | 6項目 | 5項目 |
| **Excel取得元** | M～AG列 | 列未指定（要確認） |

---

## 2. 時系列指標（T1-T5）

### 2.1 指標一覧

| 指標コード | 指標名 | Excel列 | 列インデックス | 説明 |
|:---|:---|:---|:---|:---|
| T1 | 直近1ヶ月以内に購入・利用した | - | - | 最も直近の利用 |
| T2 | 過去2～3ヶ月以内に購入・利用した | - | - | やや最近の利用 |
| T3 | 過去4ヶ月～半年未満に購入・利用した | - | - | 中期の利用 |
| T4 | 半年～1年未満に購入・利用した | - | - | やや過去の利用 |
| T5 | 1年以上前に購入・利用した | - | - | 過去の利用 |

### 2.2 各指標の詳細

#### T1: 直近1ヶ月以内に購入・利用した
- **定義**: 最も直近の購入・利用
- **評価内容**: アクティブユーザーの割合
- **マーケティング的意義**: 現在の利用者数、購入頻度の高さを測定

#### T2: 過去2～3ヶ月以内に購入・利用した
- **定義**: やや最近の購入・利用
- **評価内容**: 定期利用者の割合
- **マーケティング的意義**: 継続的な利用傾向を測定

#### T3: 過去4ヶ月～半年未満に購入・利用した
- **定義**: 中期の購入・利用
- **評価内容**: 季節性や周期性のある利用
- **マーケティング的意義**: 中期的な利用パターンを測定

#### T4: 半年～1年未満に購入・利用した
- **定義**: やや過去の購入・利用
- **評価内容**: 低頻度利用者の割合
- **マーケティング的意義**: リテンション課題の有無を測定

#### T5: 1年以上前に購入・利用した
- **定義**: 過去の購入・利用
- **評価内容**: 休眠ユーザーの割合
- **マーケティング的意義**: 離反リスクを測定

---

## 3. 分析モード詳細

### 3.1 分析軸の構成
- **X軸**: 時系列指標（固定5項目：T1～T5）
- **データ系列**: 選択した複数のセグメント
- **フィルタ**: ブランド（単一選択）

### 3.2 UI要素
- **分析項目セクション**: 【固定】バッジ表示、UI非表示（5指標は固定のため）
- **セグメントセクション**: 【MA】バッジ表示、複数選択リスト + ドラッグ＆ドロップ
- **ブランドセクション**: 【SA】バッジ表示、ドロップダウン選択

### 3.3 デフォルトチャートタイプ
**集合縦棒グラフ**

**理由**:
- 5指標の時系列推移が視覚的に明確
- 複数セグメントの比較が容易
- 購入・利用時期の分布を直感的に把握できる

---

## 4. データ要件

### 4.1 Excelファイルのフォーマット

#### 必要な列
| 列 | 列番号（0-based） | Excel列 | ヘッダー名 | 内部キー | 説明 |
|----|-----------------|---------|-----------|---------|------|
| ブランド名 | 3 | D | (任意) | - | ブランド識別子 |
| 直近1ヶ月 | - | - | 直近1ヶ月以内に購入・利用した | T1 | 時系列指標1 |
| 2～3ヶ月 | - | - | 過去2～3ヶ月以内に購入・利用した | T2 | 時系列指標2 |
| 4ヶ月～半年 | - | - | 過去4ヶ月～半年未満に購入・利用した | T3 | 時系列指標3 |
| 半年～1年 | - | - | 半年～1年未満に購入・利用した | T4 | 時系列指標4 |
| 1年以上前 | - | - | 1年以上前に購入・利用した | T5 | 時系列指標5 |

#### データ形式
- **ヘッダー行**: 3行目
- **データ開始**: 4行目以降
- **データ型**: 数値（パーセンテージ）
- **欠損値処理**: 「-」または空白は自動的に0として処理

---

## 5. 実装仕様

### 5.1 モード設定（constants/analysisConfigs.ts）

```typescript
'timeline_brand_multi_segment': {
  id: 'timeline_brand_multi_segment',
  name: 'ファネル分析②（ブランド: X=ファネル②×セグメント）',
  description: '単一ブランドにおける複数セグメントの時系列指標を比較',
  axes: {
    items: {
      role: 'X_AXIS',
      label: '分析項目',
      allowMultiple: false,
      itemSet: 'timeline',
      fixedItems: ['T1', 'T2', 'T3', 'T4', 'T5']
    },
    segments: {
      role: 'SERIES',
      label: 'セグメント比較',
      allowMultiple: true
    },
    brands: {
      role: 'FILTER',
      label: 'ブランド選択',
      allowMultiple: false
    }
  },
  dataTransform: {
    xAxis: 'items',
    series: 'segments',
    filter: 'brands'
  },
  defaultChartType: 'bar'
}
```

### 5.2 型定義（types.ts）

```typescript
// Timeline Metrics (時系列指標)
export interface TimelineMetrics {
  T1: number;  // 直近1ヶ月以内に購入・利用した
  T2: number;  // 過去2～3ヶ月以内に購入・利用した
  T3: number;  // 過去4ヶ月～半年未満に購入・利用した
  T4: number;  // 半年～1年未満に購入・利用した
  T5: number;  // 1年以上前に購入・利用した
}

export const TIMELINE_LABELS: { [key in keyof TimelineMetrics]: string } = {
  T1: '直近1ヶ月以内に購入・利用した',
  T2: '過去2～3ヶ月以内に購入・利用した',
  T3: '過去4ヶ月～半年未満に購入・利用した',
  T4: '半年～1年未満に購入・利用した',
  T5: '1年以上前に購入・利用した'
};

export const TIMELINE_KEYS: (keyof TimelineMetrics)[] = ['T1', 'T2', 'T3', 'T4', 'T5'];

// Combined metrics type
export type AllMetrics = FunnelMetrics & TimelineMetrics;

export type AnalysisMode = 
  | 'segment_x_multi_brand'
  | 'brand_x_multi_segment'
  | 'item_x_multi_brand'
  | 'timeline_brand_multi_segment'  // 追加
  | ...;
```

### 5.3 データパース処理（App.tsx）

```typescript
// Column map for timeline metrics
const timelineColMap: { [key in keyof TimelineMetrics]?: number } = {};
const timelineLabels: { [key in keyof TimelineMetrics]: string } = {
  T1: '直近1ヶ月以内に購入・利用した',
  T2: '過去2～3ヶ月以内に購入・利用した',
  T3: '過去4ヶ月～半年未満に購入・利用した',
  T4: '半年～1年未満に購入・利用した',
  T5: '1年以上前に購入・利用した'
};

// Map headers to columns
(Object.keys(timelineLabels) as (keyof TimelineMetrics)[]).forEach(key => {
  if (headerStr === timelineLabels[key]) {
    timelineColMap[key] = idx;
  }
});

// Initialize metrics
const metrics: AllMetrics = {
  FT: 0, FW: 0, FZ: 0, GC: 0, GJ: 0, GL: 0,
  T1: 0, T2: 0, T3: 0, T4: 0, T5: 0
};

// Read timeline metrics
(Object.keys(timelineLabels) as (keyof TimelineMetrics)[]).forEach(key => {
  const colIdx = timelineColMap[key];
  if (colIdx !== undefined) {
    let val = row[colIdx];
    if (val === '-' || val === undefined || val === null) val = 0;
    metrics[key] = typeof val === 'number' ? val : parseFloat(val) || 0;
  }
});
```

---

## 6. ビジネス価値

### 6.1 分析の目的
1. **セグメント別利用時期の評価**: 特定ブランドが各セグメントでいつ購入・利用されているか評価
2. **セグメント別リテンション分析**: どのセグメントでリテンションが高いか/低いか特定
3. **休眠ユーザーの把握**: セグメント別の休眠ユーザー割合を可視化

### 6.2 想定ユースケース

#### ユースケース1: セグメント別購入時期分析
**シナリオ**: 自社ブランドAの購入時期分布を若年層・中年層・シニア層で比較

- **操作**: モード4選択 → ブランドA選択 → 3セグメント選択
- **発見**: 若年層ではT1（直近1ヶ月）が高いが、シニア層ではT5（1年以上前）が高い
- **アクション**: シニア層向けのリテンション施策を強化

#### ユースケース2: セグメント別リテンション分析
**シナリオ**: ブランドBの各セグメントでのリテンション状況を確認

- **操作**: モード4選択 → ブランドB選択 → 全セグメント選択
- **発見**: 女性セグメントではT1+T2（直近3ヶ月）が高く、リテンションが良好
- **アクション**: 女性向け施策を他セグメントにも展開

#### ユースケース3: モード2との併用分析
**シナリオ**: ファネル分析（モード2）と時系列分析（モード4）を併用

- **操作**:
  1. モード2でファネル指標（認知～購入）をセグメント別に確認
  2. モード4で時系列指標（購入時期）をセグメント別に確認
- **発見**: 認知は高いが直近購入が少ないセグメントを特定
- **アクション**: そのセグメント向けの購入促進施策を立案

---

## 7. 使用例

### シナリオ1: 性年代別の利用時期分析

**目的**: 自社ブランドが各性年代でいつ購入・利用されているか把握

**手順**:
1. モード4「ファネル分析②（ブランド×複数セグメント）」を選択
2. ブランド「自社ブランド」を選択
3. セグメント「男性20代」「男性30代」「女性20代」「女性30代」を選択
4. 集合縦棒グラフで比較

**分析ポイント**:
- どの性年代で直近購入が多いか？
- どの性年代で休眠ユーザーが多いか？
- セグメント間で購入時期の分布にどのような違いがあるか？

### シナリオ2: 地域別のリテンション分析

**目的**: 自社ブランドの地域別のリテンション状況を把握

**手順**:
1. モード4を選択
2. ブランド「自社ブランド」を選択
3. セグメント「関東」「関西」「中部」「九州」を選択
4. 折れ線グラフに切り替えてトレンドを確認

**分析ポイント**:
- どの地域でリテンションが高いか？
- どの地域で休眠ユーザーが多いか？
- 地域間で購入時期の分布にどのような違いがあるか？

---

## 8. 注意事項

### 8.1 データの解釈
1. **時系列指標の特性**
   - T1～T5は過去の購入・利用時期を示す
   - T1が高い＝最近の購入が多い＝アクティブユーザーが多い
   - T5が高い＝過去の購入が多い＝休眠ユーザーが多い

2. **合計値の解釈**
   - T1～T5の合計が100%になるとは限らない
   - 購入経験のない回答者は含まれない

3. **セグメント間の数値差異**
   - セグメントによって購入頻度が異なるため、絶対値よりも相対的な傾向を重視

### 8.2 グラフの読み方
- **X軸**: 時系列指標（T1～T5）
- **縦棒の高さ**: 各指標の数値
- **色分け**: セグメントごとに異なる色
- **並び順**: ドラッグ&ドロップで調整可能

---

## 9. 他のモードとの使い分け

### モード2とモード4の使い分け
| 観点 | モード2（ファネル①） | モード4（ファネル②） |
|------|---------------------|---------------------|
| **指標種別** | ファネル指標（FT～GL） | 時系列指標（T1～T5） |
| **分析対象** | 認知から購入までの段階 | 購入・利用の時期 |
| **主な用途** | ファネル分析 | リテンション分析 |
| **発見内容** | ファネルの各段階の強み・弱み | 購入時期の分布、休眠ユーザー |

### モード4・5・6の使い分け
| 観点 | モード4 | モード5 | モード6 |
|------|---------|---------|---------|
| **固定軸** | ブランド | セグメント | 時系列指標 |
| **X軸** | 時系列5指標 | 時系列5指標 | 複数ブランド |
| **データ系列** | 複数セグメント | 複数ブランド | 複数セグメント |
| **主な用途** | セグメント別リテンション | ブランド別リテンション | 特定時期の詳細比較 |

---

## 10. まとめ

モード4「ファネル分析②（ブランド×複数セグメント）」は、特定のブランドを複数のセグメント間で時系列指標により比較する分析モードです。

### 主な特徴
- **5指標評価**: 購入・利用時期を5段階で可視化
- **セグメント比較**: セグメント間の購入時期の違いを直感的に把握
- **リテンション分析**: セグメント別のリテンション状況を評価
- **休眠ユーザー把握**: セグメント別の休眠ユーザー割合を可視化

### 活用シーン
- セグメント別のリテンション分析
- 性年代別・地域別の購入時期分布の把握
- 休眠ユーザー掘り起こし施策の立案
- セグメント別のアクティブユーザー率の評価

### モード2との補完関係
- **モード2**: ファネル分析（認知～購入）
- **モード4**: 時系列分析（購入時期）
- 両方を併用することで、ファネルとリテンションの両面から評価可能

このモードを活用することで、セグメント別の購入・利用時期を詳細に評価し、効果的なリテンション施策を立案できます。

---

**文書ステータス**: 要件定義完了  
**作成日**: 2025-11-29  
**バージョン**: 1.0

