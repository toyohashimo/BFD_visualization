# 過去比較モード Mode 4 要件定義書

## 📋 概要

**グローバルモード**: 過去比較モード  
**モード番号**: 4  
**モードID**: `historical_brand_power_segment_brand`  
**モード名**: ブランドパワー分析①（セグメント、ブランド: X=現在パワー×過去比較）  
**実装日**: 2025-11-30  
**ステータス**: 📝 要件定義完了

---

## 🎯 目的

単一セグメント・単一ブランドにおけるブランドパワー指標（現在パワー）の時系列変化を可視化し、過去のデータと比較することでブランドの成長や変化を分析する。

---

## 📊 モード概要

### 分析軸の構成

| 軸 | 役割 | 値 | 選択方式 | 詳細 |
|----|------|-----|---------|------|
| **分析項目** | X_AXIS | BP1, BP2, BP3, BP4 | 固定 | ブランドパワー指標（現在パワー） |
| **セグメント** | FILTER | セグメント名 | SA（単一選択） | 分析対象のセグメント |
| **ブランド** | FILTER | ブランド名 | SA（単一選択） | 分析対象のブランド |
| **データ系列** | SERIES | データソース（期間） | 複数（最大3） | 時系列データ |

### ブランドパワー指標（現在パワー）

| 指標キー | 指標名 | 説明 |
|---------|--------|------|
| BP1 | 認知 | ブランドの認知度 |
| BP2 | 興味・関心 | ブランドへの興味・関心度 |
| BP3 | 購入意向 | ブランドの購入意向 |
| BP4 | 推奨意向 | ブランドの推奨意向 |

---

## 🔄 詳細分析モードとの対応関係

### 対応する詳細分析モード

**詳細分析モード Mode 9**: `brand_power_segment_brands`
- 名称: ブランドパワー分析①（セグメント: X=現在パワー×ブランド）
- 比較軸: 複数ブランド間の比較
- X軸: ブランドパワー指標（BP1-BP4）
- データ系列: 複数ブランド

**過去比較モード Mode 4**: `historical_brand_power_segment_brand`（本モード）
- 名称: ブランドパワー分析①（セグメント、ブランド: X=現在パワー×過去比較）
- 比較軸: 単一ブランドの時系列比較
- X軸: ブランドパワー指標（BP1-BP4）
- データ系列: 複数時点データ

### 違いの明確化

| 項目 | 詳細分析モード (Mode 9) | 過去比較モード (Mode 4) |
|------|------------------------|------------------------|
| **比較対象** | 複数ブランド | 複数時点 |
| **セグメント選択** | SA（単一） | SA（単一） |
| **ブランド選択** | MA（複数） | SA（単一） |
| **データソース** | 1つ（現在） | 最大3つ（時系列） |
| **凡例表示** | ブランド名 | データソース名（期間） |
| **分析目的** | ブランド間の競合比較 | 同一ブランドの成長追跡 |

---

## 🎨 UI仕様

### サイドバー構成

```
┌─────────────────────────────────┐
│ [詳細分析] [過去比較] ★        │
├─────────────────────────────────┤
│ 📁 データソース管理            │
│   ○ 2025年6月  [編集] [削除]   │
│   ○ 2024年6月  [編集] [削除]   │
│   ○ 2023年6月  [編集] [削除]   │
│   [+ ファイル追加 (3/3)]        │
├─────────────────────────────────┤
│ 📊 分析モード                   │
│   ▼ Mode 4: ブランドパワー分析① │
├─────────────────────────────────┤
│ 📂 セグメント (SA)              │
│   ▼ 全体                        │
├─────────────────────────────────┤
│ 🏷️ ブランド (SA)                │
│   ▼ ブランドA                   │
├─────────────────────────────────┤
│ 📈 分析項目: 現在パワー (固定)  │
└─────────────────────────────────┘
```

### 選択制約

- **セグメント**: 単一選択（SA）固定、ドロップダウン表示
- **ブランド**: 単一選択（SA）固定、ドロップダウン表示
- **分析項目**: BP1-BP4固定、選択不可（自動）

---

## 📈 グラフ仕様

### デフォルトチャートタイプ

**レーダーチャート（Radar Chart）**

### 理由

ブランドパワー分析は4つの指標（認知、興味・関心、購入意向、推奨意向）を総合的に把握する必要があり、レーダーチャートが最適:
- 4つの指標のバランスを視覚的に把握
- 時系列でのブランドパワーの変化を面積で比較
- 強み・弱みの変化が一目瞭然

### 切り替え可能なチャートタイプ

- ✅ レーダーチャート（デフォルト）
- ✅ 棒グラフ
- ✅ 折れ線グラフ

### グラフ出力例（レーダーチャート）

```
         BP1（認知）
             ↑
             |
     60% ／｜＼
        /   |   \
BP4 ← /    |    \ → BP2
     \     |     /   （興味・関心）
      \    |    /
       \   |   /
    40% ＼｜／
         ↓
    BP3（購入意向）

凡例:
━━━ 2025年6月
─ ─ 2024年6月
・・・ 2023年6月
```

### グラフ出力例（棒グラフ）

```
100% ┤
 80% ┤
 60% ┤ ███ ▓▓▓ ░░░
 40% ┤ ███ ▓▓▓ ░░░
 20% ┤ ███ ▓▓▓ ░░░
  0% ┼─────────────────
     BP1  BP2  BP3  BP4

凡例:
███ 2025年6月
▓▓▓ 2024年6月
░░░ 2023年6月
```

---

## 📊 データテーブル仕様

### 表示形式

```
┌────────────┬─────┬──────────┬──────┬──────┐
│            │ BP1 │   BP2    │ BP3  │ BP4  │
│            │認知 │興味・関心│購入意向│推奨意向│
├────────────┼─────┼──────────┼──────┼──────┤
│ 2025年6月  │ 65.2│   42.3   │ 28.5 │ 15.7 │
│ 2024年6月  │ 62.8│   39.1   │ 26.2 │ 14.3 │
│ 2023年6月  │ 60.5│   36.8   │ 24.9 │ 13.1 │
└────────────┴─────┴──────────┴──────┴──────┘
```

### 表示ルール

- **行（縦軸）**: データソース名（期間）
- **列（横軸）**: ブランドパワー指標（BP1-BP4）
- **セル値**: パーセント表示（小数点第1位まで）
- **並び順**: データソースの追加順

---

## 🛠️ 技術実装仕様

### 1. 設定追加 (`constants/analysisConfigs.ts`)

```typescript
export const HISTORICAL_ANALYSIS_MODE_CONFIGS: Record<string, AnalysisModeConfig> = {
    // 既存のMode 1-3...

    'historical_brand_power_segment_brand': {
        id: 'historical_brand_power_segment_brand',
        name: 'ブランドパワー分析①（セグメント、ブランド: X=現在パワー×過去比較）',
        description: '単一セグメント・単一ブランドにおける過去データとの比較（ブランドパワー）',
        axes: {
            items: {
                role: 'X_AXIS',
                label: '項目',
                allowMultiple: false,
                itemSet: 'brandPower',
                fixedItems: ['BP1', 'BP2', 'BP3', 'BP4']
            },
            segments: {
                role: 'FILTER',
                label: 'セグメント',
                allowMultiple: false  // 過去比較モードでは単一選択のみ
            },
            brands: {
                role: 'FILTER',
                label: 'ブランド',
                allowMultiple: false  // 過去比較モードでは単一選択のみ
            }
        },
        dataTransform: {
            xAxis: 'items',
            series: 'dataSources',  // データソースが系列になる
            filter: 'segments'
        },
        defaultChartType: 'radar'  // レーダーチャートがデフォルト
    }
};
```

### 2. モード選択順序の更新

```typescript
export const HISTORICAL_ANALYSIS_MODE_ORDER = [
    'historical_funnel1_segment_brand',    // Mode 1
    'historical_funnel2_segment_brand',    // Mode 2
    // Mode 3は今後追加予定
    'historical_brand_power_segment_brand' // Mode 4（本モード）
];
```

### 3. 型定義の更新 (`src/types/analysis.ts`)

```typescript
export type AnalysisMode =
  | ''
  // 詳細分析モード
  | 'segment_x_multi_brand'
  // ... 他の詳細分析モード ...
  // 過去比較モード
  | 'historical_funnel1_segment_brand'
  | 'historical_funnel2_segment_brand'
  | 'historical_brand_power_segment_brand';  // 追加
```

---

## 🔄 データ変換ロジック

### 既存ロジックの再利用

Mode 1-2で実装済みの`transformDataForHistoricalChart`関数をそのまま使用可能:

```typescript
// utils/dataTransforms.ts
export const transformDataForHistoricalChart = (
  dataSources: DataSource[],
  config: AnalysisModeConfig,
  selectedSegment: string,
  selectedBrand: string,
  selectedItem: string,
  labelGetters: Record<AxisType, (key: string) => string>
): ChartDataPoint[] | null
```

### データ変換の流れ

1. **アクティブなデータソースを抽出**
   ```typescript
   const activeSources = dataSources.filter(ds => ds.isActive);
   ```

2. **X軸の項目キー取得**
   ```typescript
   const xAxisKeys = config.axes.items.fixedItems;
   // ['BP1', 'BP2', 'BP3', 'BP4']
   ```

3. **各項目ごとにデータポイント生成**
   ```typescript
   {
     name: '認知',
     '2025年6月': 65.2,
     '2024年6月': 62.8,
     '2023年6月': 60.5
   }
   ```

### データ取得パス

```typescript
const value = source.data[selectedSegment]?.[selectedBrand]?.[itemKey] || 0;
```

---

## 📊 実装の容易さ分析

### Mode 1-2で構築された資産の活用

| 資産 | 活用方法 | 変更の必要性 |
|------|---------|------------|
| **データ変換ロジック** | `transformDataForHistoricalChart` | ❌ 変更不要 |
| **UIコンポーネント** | `ChartArea`, `Sidebar` 等 | ❌ 変更不要 |
| **フック** | `useGlobalMode`, `useMultiDataSource` | ❌ 変更不要 |
| **型定義** | `DataSource`, `GlobalMode` | ❌ 変更不要 |
| **レーダーチャート** | 既存の`chartType`対応 | ❌ 変更不要 |

### 追加が必要なコード

| ファイル | 追加内容 | 行数 |
|---------|---------|------|
| `constants/analysisConfigs.ts` | Mode 4の設定 | 約30行 |
| `src/types/analysis.ts` | 型定義に1行追加 | 1行 |
| **合計** | | **約31行** |

### 予想実装時間

- **設定追加**: 3分
- **型定義更新**: 1分
- **動作確認**: 5分
- **合計**: **約10分**

---

## ✅ 完了条件

### 必須条件

- [ ] `historical_brand_power_segment_brand`の設定が追加されている
- [ ] `HISTORICAL_ANALYSIS_MODE_ORDER`に追加されている
- [ ] 型定義`AnalysisMode`に追加されている
- [ ] 過去比較モードでMode 4が選択可能
- [ ] X軸にBP1-BP4が表示される
- [ ] デフォルトでレーダーチャートが表示される
- [ ] グラフの凡例にデータソース名が表示される
- [ ] データテーブルが正しく表示される
- [ ] グラフタイプ切り替えが動作する（レーダー、棒、折れ線）
- [ ] リンターエラーなし
- [ ] TypeScriptコンパイルエラーなし

### オプション条件（Phase 4で対応予定）

- [ ] CSV エクスポートが動作する
- [ ] 画像エクスポートが動作する

---

## 🧪 テストケース

### 機能テスト

| ID | テストケース | 期待結果 | 優先度 |
|----|-------------|---------|--------|
| TC-01 | Mode 4が選択肢に表示される | Mode 4が選択可能 | P0 |
| TC-02 | X軸にBP1-BP4が表示される | 4つの指標が正しく表示 | P0 |
| TC-03 | デフォルトでレーダーチャートが表示 | レーダーチャートが描画される | P0 |
| TC-04 | 棒グラフに切り替え | 棒グラフが正しく表示される | P1 |
| TC-05 | 折れ線グラフに切り替え | 折れ線グラフが正しく表示される | P1 |
| TC-06 | データテーブルの表示 | 行=データソース、列=BP1-BP4 | P0 |
| TC-07 | データソースON/OFF切り替え | グラフから該当系列が削除/追加 | P0 |
| TC-08 | セグメント変更 | グラフが正しく更新される | P0 |
| TC-09 | ブランド変更 | グラフが正しく更新される | P0 |

### エッジケーステスト

| ID | テストケース | 期待結果 | 優先度 |
|----|-------------|---------|--------|
| TC-10 | データソース1つのみ | 単一系列で表示される | P1 |
| TC-11 | データソース3つすべてON | 3系列すべて表示される | P1 |
| TC-12 | データが存在しないブランド | 0値またはエラーメッセージ | P2 |
| TC-13 | すべての指標が0の場合 | レーダーチャートが中心点のみ | P2 |

---

## 📚 参考資料

### 関連ドキュメント

1. `docs/HISTORICAL_COMPARISON_REQUIREMENTS.md` - 過去比較モード全体の要件定義
2. `docs/HISTORICAL_MODE1_IMPLEMENTATION_REPORT.md` - Mode 1の実装実績
3. `docs/HISTORICAL_MODE2_IMPLEMENTATION_REPORT.md` - Mode 2の実装実績
4. `docs/mode9_brand_power_segment_brands_requirements.md` - 対応する詳細分析モードの仕様
5. `docs/brand_power_analysis_summary.md` - ブランドパワー分析の全体設計

### 設定駆動型アプローチの成果

**Mode 1実装**: 約3日（基盤構築）  
**Mode 2実装**: 約5分（設定追加のみ）  
**Mode 4実装予測**: 約10分（設定追加のみ、レーダーチャートは既存実装を活用）

---

## 🎯 実装優先度

### 高優先度 (P0)

- ✅ 要件定義書作成（本ドキュメント）
- ⏸️ 設定追加（`constants/analysisConfigs.ts`）
- ⏸️ 型定義更新（`src/types/analysis.ts`）
- ⏸️ 動作確認

### 中優先度 (P1)

- ⏸️ グラフタイプ切り替えテスト
- ⏸️ エッジケーステスト

### 低優先度 (P2)

- ⏸️ CSV/画像エクスポート対応（Phase 4）
- ⏸️ ドキュメント更新

---

## 💡 実装時の注意点

### 1. レーダーチャートのデフォルト設定

```typescript
defaultChartType: 'radar'  // 必須
```

### 2. ブランドパワー指標の固定

```typescript
itemSet: 'brandPower',
fixedItems: ['BP1', 'BP2', 'BP3', 'BP4']  // 必ず4つの指標
```

### 3. データ系列はデータソース

```typescript
series: 'dataSources'  // Mode 1-2と同じ
```

### 4. 単一選択の徹底

```typescript
allowMultiple: false  // セグメント・ブランドともに単一選択
```

---

## 🔄 Mode 1-2からの学習ポイント

### 再利用できる実装パターン

1. **設定駆動型アプローチ**: 設定を追加するだけで動作
2. **汎用的なデータ変換**: `itemSet`が異なるだけで同じロジックが適用可能
3. **既存UIコンポーネント**: すべて修正なしで動作
4. **型安全性**: TypeScriptによるコンパイル時チェック

### 避けるべき問題

- ❌ `localStorage`容量超過 → 既に解決済み（メタデータのみ保存）
- ❌ 無限ループ → 既に解決済み（`useMemo`でメモ化）
- ❌ グラフが表示されない → 汎用的な実装で回避済み

---

## 🚀 次のステップ

### Mode 5以降の実装計画

Mode 4の実装完了後、以下の順序で実装を進める：

1. **Mode 3**: ファネル分析③（未定義の場合はスキップ）
2. **Mode 5-6**: タイムライン関連
3. **Mode 7-8**: ブランドイメージ分析
4. **Mode 9-12**: ブランドパワー分析②（将来性パワー）
5. **Mode 13-14**: アーキタイプ分析

### 一括実装の検討

Mode 4が5-10分で完了した場合、残りのモードを一括実装することで効率化が可能。

---

## 📊 実装統計（予測）

### コード変更量（予測）

| ファイル | 追加行数 | 削除行数 | 変更行数 |
|---------|---------|---------|---------|
| `constants/analysisConfigs.ts` | 30 | 1 | 31 |
| `src/types/analysis.ts` | 1 | 0 | 1 |
| **合計** | **31** | **1** | **32** |

### 再利用率（予測）

- **新規コード**: 0行
- **設定追加**: 31行
- **型定義追加**: 1行
- **再利用コード**: 100%（すべてMode 1-2の資産）

---

## ✨ 期待される成果

### 機能面

- ✅ ブランドパワーの時系列変化を可視化
- ✅ レーダーチャートによる総合的な把握
- ✅ 4つの指標のバランス変化を一目で理解

### 技術面

- ✅ 設定追加のみで実装完了
- ✅ 既存コードの変更なし
- ✅ 高い保守性と拡張性

### ビジネス面

- ✅ ブランドの成長追跡が容易
- ✅ 過去データとの比較で戦略立案に貢献
- ✅ レポート作成の効率化

---

## 🎉 まとめ

過去比較モード Mode 4は、Mode 1-2で確立した設計パターンを完全に踏襲し、**約10分で実装可能**な見込みです。

### 主要な特徴

1. **設定追加のみで実装**: 既存コードの変更不要
2. **レーダーチャート対応**: 既存実装を活用
3. **汎用的なデータ変換**: `itemSet: 'brandPower'`に対応
4. **完全な型安全性**: コンパイル時エラー検出

### 実装の容易さの理由

- Mode 1-2の基盤が完璧に機能
- すべてのUIコンポーネントが再利用可能
- データ変換ロジックが汎用的
- レーダーチャートも既存実装済み

---

**Document Version**: 1.0  
**Last Updated**: 2025-11-30  
**Author**: AI Assistant  
**Status**: ✅ 要件定義完了  
**Next Step**: 実装フェーズへ移行


