# デバッグモード（開発者向け）

このドキュメントはデバッグモードの使用方法と実装詳細をまとめたものです。

> [!WARNING]
> このモードは開発・テスト・デモ目的のものです。本番環境では適切に管理してください。

## 概要

デバッグモードは、開発者やテスターがAPIキー設定なしでAIサマリー機能をテストできるようにする機能です。デフォルトのAPIキーを自動的に使用することで、開発・デモンストレーション時の設定手順を省略できます。

### 主な用途

- **開発中のテスト**: APIキー設定なしでAI機能を即座にテスト
- **デモンストレーション**: クライアントへのプレゼン時に設定不要
- **トラブルシューティング**: ユーザーのAPIキー問題の切り分け

## 起動方法

### トリガー

**IconBar下部の隠しエリアをShift+ダブルクリック**

- 設定アイコン（歯車）の下に8pxの透明エリアが配置されています
- このエリアをShiftキーを押しながらダブルクリックすると、デバッグモードがON/OFFします
- 切り替え後、ページは自動的にリロードされます（環境変数を再読み込みするため）

### 視覚的な位置

```
┌────────────────┐
│   IconBar      │
│                │
│  ┌──────────┐  │
│  │ 設定アイコン │  │ ← 歯車アイコン
│  └──────────┘  │
│  [隠しエリア]    │ ← ここをShift+ダブルクリック（8px高さ）
└────────────────┘
```

## デバッグモードの機能

### 1. デフォルトAPIキーの自動使用

カスタムAPIキーが未設定の場合、デフォルトのAPIキーを自動的に使用します。

**APIキーの優先順位**:
1. **カスタムAPIキー** - ユーザーが設定画面で入力したAPIキー（最優先）
2. **デフォルトAPIキー** - デバッグモードON時のみ使用（環境変数から取得）
3. **なし** - AI機能は無効

**環境変数**:
- `VITE_DEFAULT_GEMINI_API_KEY`: Base64エンコードされたデフォルトAPIキー
- デコード処理は `src/hooks/useAISettings.ts` の `getDefaultApiKey()` で実行

### 2. AIサマリー機能の有効化

デバッグモードをONにすると、カスタムAPIキーを設定しなくてもAIサマリー機能が利用可能になります。

- AIサマリーボタンが表示されます
- サマリー生成時にデフォルトAPIキーが使用されます
- ユーザーはAPIキー取得の手順を省略できます

### 3. 視覚的フィードバック

#### 設定アイコン（歯車）の変化

**デバッグモードOFF時**:
- 背景: 透明
- テキスト: グレー (`text-gray-600`)
- アイコン: 通常の向き
- ツールチップ: 「設定」
- ホバー: `hover:bg-gray-200`

**デバッグモードON時**:
- 背景: インディゴブルー (`bg-indigo-600`)
- テキスト: 白 (`text-white`)
- アイコン: **180度回転** (`rotate-180`)
- ツールチップ: 「設定（デバッグモード有効）」
- ホバー: `hover:bg-indigo-700`

この視覚的な変化により、デバッグモードが有効かどうかを一目で判断できます。

### 4. 設定画面での表示

#### DEBUGモードテキスト

設定画面（SettingsModal）のフッター部分に、デバッグモードがONの場合のみ「DEBUGモード」というテキストが表示されます。

- 位置: 設定画面下部、ボタンの上
- スタイル: インディゴ色、大文字、太字
- 表示条件: `settings.isDebugMode === true`

#### APIキーフィールドの挙動

**デバッグモードON + カスタムAPIキー未設定の場合**:
- 入力フィールドは空欄表示
- プレースホルダー: 「デバッグモード: デフォルトAPIキーを使用中」
- デフォルトAPIキーは表示されない（セキュリティのため）

**デバッグモードOFF**:
- プレースホルダー: 「APIキーが未設定です。AIサマリー機能は利用できません」

#### LocalStorage削除ボタン

**デバッグモードON時のみ表示**:
- 位置: 設定画面フッター、左側
- スタイル: 赤いテキストとボーダー、ゴミ箱アイコン付き
- ラベル: 「LocalStorage削除」
- 表示条件: `settings.isDebugMode === true`

**機能**:
- すべてのLocalStorageデータを削除
- 確認ダイアログを表示（誤操作防止）
- 削除後、自動的にページをリロード

**削除される項目**:
- `ai_summary_debug_mode`: デバッグモード状態
- `ai_summary_api_key`: カスタムAPIキー
- `ai_summary_model`: Geminiモデル設定
- `ai_summary_max_tokens`: 最大トークン数
- `ai_summary_temperature`: 温度設定
- その他すべてのLocalStorageデータ

**使用例**:
- テスト環境のリセット
- 設定のクリーンアップ
- トラブルシューティング時の初期化

## 状態管理

### LocalStorage永続化

デバッグモードの状態は、ブラウザの `localStorage` に保存されます。

- **キー**: `ai_summary_debug_mode`
- **値**: `'true'` (ON) または `'false'` (OFF)
- **保持期間**: ブラウザのデータクリアまで永続

ページをリロードしても、デバッグモードの状態は保持されます。

### ページ自動リロード

デバッグモードをON/OFF切り替えた際、100ms後にページが自動的にリロードされます。

**理由**:
- 環境変数（`VITE_DEFAULT_GEMINI_API_KEY`）を再読み込みするため
- Viteの環境変数は実行時に静的に埋め込まれるため、リロードが必要

**実装**:
```typescript
setTimeout(() => {
  window.location.reload();
}, 100);
```

## 実装詳細（開発者向け）

### 関連ファイル

| ファイル | 役割 |
|:---|:---|
| `src/hooks/useAISettings.ts` | 状態管理とAPIキー優先順位ロジック |
| `components/IconBar.tsx` | デバッグモードトグルUI |
| `components/SettingsModal.tsx` | 設定画面表示 |
| `src/services/aiSummaryService.ts` | APIキー利用 |

### useAISettings.ts

**主要な関数**:

- `toggleDebugMode()`: デバッグモードをON/OFF切り替え
- `getEffectiveApiKey()`: 実際に使用するAPIキーを取得（優先順位ロジック）
- `getDefaultApiKey()`: 環境変数からデフォルトAPIキーをデコード

**LocalStorageキー**:
- `ai_summary_debug_mode`: デバッグモード状態
- `ai_summary_api_key`: カスタムAPIキー
- その他の設定（`ai_summary_model`, `ai_summary_max_tokens`, 等）

### IconBar.tsx

**隠しエリアの実装**:
```tsx
{/* デバッグモード隠しエリア（Shift+ダブルクリック） */}
<div
  onDoubleClick={handleDebugClick}
  className="w-full h-8 cursor-default"
  title=""
/>
```

**イベントハンドラ**:
```typescript
const handleDebugClick = (e: React.MouseEvent) => {
  if (!e.shiftKey) return;
  
  if (onToggleDebugMode) {
    onToggleDebugMode();
    console.log('[Debug Mode] Toggled:', !isDebugMode ? 'ON' : 'OFF');
  }
};
```

## セキュリティに関する注意

### デフォルトAPIキーの保護

1. **環境変数の管理**
   - `.env.local` や `.env.production` に保存
   - Gitにコミットしない（`.gitignore` に追加）
   - Base64エンコードで簡易的な難読化を実施

2. **本番環境での使用**
   - 本番環境では、デフォルトAPIキーを設定しないことを推奨
   - または、使用制限を設けたAPIキーを使用
   - 不正使用を検知するため、APIキーの使用状況を監視

3. **漏洩リスク**
   - クライアントサイドのJavaScriptに埋め込まれるため、完全には隠蔽できません
   - デベロッパーツールで確認可能
   - 重要な本番環境では使用を避けてください

### 推奨事項

- **開発環境のみで使用**: ローカル開発やテスト環境に限定
- **定期的なキーのローテーション**: デフォルトAPIキーを定期的に変更
- **使用量の監視**: Google Cloud Consoleで異常な使用を監視

## 使用例とユースケース

### 1. 開発中のテスト

```
シナリオ: AIサマリー機能の新機能を実装中

1. デバッグモードをONにする（Shift+ダブルクリック）
2. APIキー設定をスキップ
3. すぐにAIサマリーボタンでテスト開始
4. 開発完了後、デバッグモードをOFFにする
```

### 2. デモンストレーション

```
シナリオ: クライアントへのプレゼンテーション

1. デモ環境でデバッグモードをONにしておく
2. プレゼン中、設定画面を開かずにAI機能をデモ
3. クライアントにAPIキーを見せる必要がない
4. スムーズなデモが可能
```

### 3. トラブルシューティング

```
シナリオ: ユーザーが「AIサマリーが動かない」と報告

1. ユーザーのAPIキー設定を確認
2. デバッグモードをONにしてデフォルトAPIキーで動作確認
3. デフォルトAPIキーで動作する場合 → ユーザーのAPIキーに問題
4. デフォルトAPIキーでも動作しない場合 → 別の問題を調査
```

## トラブルシューティング

### デバッグモードがONにならない

**症状**: IconBarの隠しエリアをShift+ダブルクリックしても反応がない

**確認事項**:
1. Shiftキーを押しながらダブルクリックしているか確認
2. 設定アイコンの下のエリアをクリックしているか確認
3. ブラウザのコンソールでエラーを確認
4. `onToggleDebugMode` プロップが `IconBar` に渡されているか確認（`App.tsx`）

### デフォルトAPIキーが機能しない

**症状**: デバッグモードONでもAIサマリーが動作しない

**確認事項**:
1. 環境変数 `VITE_DEFAULT_GEMINI_API_KEY` が設定されているか確認
2. Base64エンコードされた値が正しいか確認
3. ページがリロードされたか確認（切り替え後に自動リロードされるはず）
4. ブラウザのコンソールで実際のAPIキーをデバッグ出力（開発時のみ）

```typescript
// デバッグ用（本番では削除）
console.log('Effective API Key:', getEffectiveApiKey());
```

### 環境変数が読み込まれない

**症状**: `.env.local` にAPIキーを設定したが認識されない

**確認事項**:
1. `.env.local` ファイルがプロジェクトルートにあるか確認
2. 環境変数名が `VITE_` で始まっているか確認（Viteの要件）
3. 開発サーバーを再起動（`npm run dev` を再実行）
4. `.env.local` のフォーマットが正しいか確認:
   ```
   VITE_DEFAULT_GEMINI_API_KEY=<Base64エンコードされた値>
   ```

## 注意事項

### 保守性

- デバッグモードの変更時は、このドキュメントを必ず更新してください
- コード内にコメントを残し、将来の開発者が理解できるようにしてください

### 履歴

| 日付 | 変更内容 |
|:---|:---|
| 2025-12-04 | デバッグモード機能実装 |
| 2025-12-05 | デバッグモードドキュメントを04_development/に集約 |
| 2025-12-05 | LocalStorage削除ボタンを設定画面に追加（デバッグモード時のみ） |

---

**関連ドキュメント**:
- [隠しコマンド](./hidden_commands.md) - サンプルファイル自動読み込みコマンド
- [AIサマリー機能実装ガイド](../02_features/ai_summary/implementation.md) - AIサマリー機能の詳細
