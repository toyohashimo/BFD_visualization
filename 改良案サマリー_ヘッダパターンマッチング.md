# Excelパーサー改良案サマリー

## 📌 概要

ブランドイメージ項目の抽出を、固定範囲から**パターンマッチング**に変更し、ヘッダの複数行（行0、行1、行2）を活用した柔軟な抽出方法を実装しました。✅ **実装完了**

## 🎯 目的

1. **柔軟性の向上**: 列位置が変わっても自動的に対応
2. **一貫性の確保**: すべてのメトリクス項目を同様の方法で抽出
3. **保守性の向上**: 固定範囲の削除により、設定変更が不要

## 🔍 現状の問題点

### ブランドイメージ項目の固定範囲抽出

```typescript
// 現在の実装（固定範囲）
const { start, end } = BRAND_IMAGE.COLUMN_RANGE;  // 41-175
for (let colIdx = start; colIdx < end; colIdx++) {
  // ...
}
```

**問題**:
- ファイルによって列数が異なる（202406: 207列、202506: 195列）
- 列位置が変わった場合に対応できない
- 他のメトリクス項目と一貫性がない

## ✨ 改良内容

### 1. ヘッダ構造の活用

Excelファイルのヘッダ構造：
- **行0（1行目）**: カテゴリ名（例：「現在パワー項目構成要素」「共通68イメージ」）
- **行1（2行目）**: 項目名（例：「認知あり」「ブランドイメージ」）
- **行2（3行目）**: 詳細項目名（実際のヘッダーとして使用）

### 2. パターンマッチングによる抽出

```typescript
// 改良後の実装（パターンマッチング）
itemRow.forEach((itemName: any, colIdx: number) => {
  if (itemName.includes('ブランドイメージ')) {
    // この列をブランドイメージ項目として抽出
    const headerName = headerRow[colIdx];
    items.push({ name: headerName, columnIndex: colIdx });
  }
});
```

**メリット**:
- 列位置に依存しない
- ファイルごとに列数が異なっても対応可能
- 他のメトリクス項目と同様の抽出方法

## 📝 実装変更点

### 1. 定数の更新（`src/config/constants.ts`）

```typescript
export const EXCEL_STRUCTURE = {
  HEADER_ROW_INDEX: 2,        // 3行目がヘッダー
  CATEGORY_ROW_INDEX: 0,      // 1行目がカテゴリ ★追加
  ITEM_ROW_INDEX: 1,          // 2行目が項目名 ★追加
  DATA_START_INDEX: 3,
  BRAND_NAME_COLUMN: 3,
  // BRAND_IMAGE_START_COLUMN: 41,   // 削除
  // BRAND_IMAGE_END_COLUMN: 175,    // 削除
} as const;

export const BRAND_IMAGE = {
  EXCLUDE_KEYWORDS: ['あてはまるものはない'],
  PATTERNS: {
    ITEM_KEYWORDS: ['ブランドイメージ'],  // 行1のキーワード
  },
} as const;
```

### 2. ExcelParserクラスの更新（`src/services/excelParser/ExcelParser.ts`）

#### 追加メソッド

```typescript
/**
 * ヘッダ情報を取得（3行分）
 */
private getHeaderInfo(jsonData: any[]): {
  categoryRow: any[];
  itemRow: any[];
  headerRow: any[];
}
```

#### 変更メソッド

```typescript
/**
 * ブランドイメージ項目を抽出（パターンマッチング版）
 */
private extractBrandImageItems(
  categoryRow: any[],
  itemRow: any[],
  headerRow: any[]
): BrandImageItem[]
```

#### 修正メソッド

```typescript
/**
 * 単一シートをパース
 */
private parseSheet(...): {
  // getHeaderInfoを使用してヘッダ情報を取得
  // extractBrandImageItemsに3行分のヘッダを渡す
}
```

## ✅ 期待される効果

### 1. 柔軟性の向上
- ✅ 列位置が変わっても自動的に対応
- ✅ ファイルごとに列数が異なっても問題なし
- ✅ 将来のファイル形式変更にも対応可能

### 2. 一貫性の確保
- ✅ すべてのメトリクス項目を同様の方法で抽出
- ✅ ヘッダの複数行を活用した統一的なロジック

### 3. 保守性の向上
- ✅ 固定範囲の削除により、設定変更が不要
- ✅ パターンマッチングにより、より直感的な抽出

## 🧪 テスト計画

### テストケース

1. **既存ファイルでの動作確認**
   - [ ] 202406ファイル（207列）でブランドイメージ項目が正しく抽出される
   - [ ] 202506ファイル（195列）でブランドイメージ項目が正しく抽出される

2. **過去比較モードでの動作確認**
   - [ ] 複数ファイルを読み込んで過去比較が正しく動作する
   - [ ] ブランドイメージ分析モードが正しく動作する

3. **エッジケース**
   - [ ] ブランドイメージ項目が見つからない場合の処理
   - [ ] 除外キーワードが含まれる項目の除外

## 📋 実装チェックリスト

- [x] `src/config/constants.ts` を更新 ✅ **完了**
- [x] `src/services/excelParser/ExcelParser.ts` を更新 ✅ **完了**
  - [x] `getHeaderInfo`メソッドの追加 ✅
  - [x] `extractBrandImageItems`メソッドのパターンマッチング化 ✅
  - [x] `parseSheet`メソッドの更新 ✅
- [ ] 既存のファイルで動作確認
- [ ] 過去比較モードで動作確認
- [x] エラーハンドリングの確認 ✅ **実装済み**
- [x] ログ出力の確認 ✅ **実装済み**
- [x] ドキュメント更新 ✅ **進行中**

## 📚 関連ドキュメント

- `改良案_ヘッダパターンマッチング.md` - 詳細な改良案
- `実装コード_ヘッダパターンマッチング.ts` - 実装コードサンプル
- `問題分析_過去比較モード.md` - 問題分析

## 🔄 移行手順

1. **Phase 1: 実装** ✅ **完了**
   - ✅ 定数の更新（`EXCEL_STRUCTURE`に`CATEGORY_ROW_INDEX`、`ITEM_ROW_INDEX`を追加）
   - ✅ `BRAND_IMAGE.PATTERNS.ITEM_KEYWORDS`の定義
   - ✅ `getHeaderInfo`メソッドの追加
   - ✅ `extractBrandImageItems`メソッドのパターンマッチング化
   - ✅ `parseSheet`メソッドの更新

2. **Phase 2: テスト** 🔄 **進行中**
   - [ ] 既存ファイルでの動作確認
   - [ ] 過去比較モードでの動作確認

3. **Phase 3: リリース** ⏳ **待機中**
   - [ ] 既存の動作に影響がないことを確認
   - [x] ドキュメント更新 ✅ **完了**

## 💡 今後の拡張可能性

この改良により、将来的に以下の拡張が容易になります：

1. **他のメトリクス項目のパターンマッチング化**
   - 行0のカテゴリ名を活用した抽出
   - より柔軟な抽出ロジック

2. **複数キーワード対応**
   - 複数のキーワードパターンに対応
   - より高度な抽出ロジック

3. **動的な範囲検出**
   - カテゴリ名から範囲を自動検出
   - より自動化された抽出

