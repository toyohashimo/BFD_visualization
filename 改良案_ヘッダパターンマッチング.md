# Excelãƒ‘ãƒ¼ã‚µãƒ¼æ”¹è‰¯æ¡ˆï¼šãƒ˜ãƒƒãƒ€ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°

## ğŸ“‹ ç¾çŠ¶ã®å•é¡Œç‚¹

### 1. ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸é …ç›®ã®å›ºå®šç¯„å›²æŠ½å‡º
ç¾åœ¨ã®å®Ÿè£…ã§ã¯ã€ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸é …ç›®ã‚’å›ºå®šç¯„å›²ï¼ˆåˆ—41-175ï¼‰ã§æŠ½å‡ºã—ã¦ã„ã¾ã™ï¼š

```typescript
const { start, end } = BRAND_IMAGE.COLUMN_RANGE;  // å›ºå®š: 41-175
for (let colIdx = start; colIdx < end; colIdx++) {
  // ...
}
```

**å•é¡Œç‚¹**:
- ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ˆã£ã¦åˆ—æ•°ãŒç•°ãªã‚‹å ´åˆï¼ˆ202406: 207åˆ—ã€202506: 195åˆ—ï¼‰ã€ç¯„å›²å¤–ã®åˆ—ãŒå­˜åœ¨ã™ã‚‹å¯èƒ½æ€§
- åˆ—ä½ç½®ãŒå¤‰ã‚ã£ãŸå ´åˆã«å¯¾å¿œã§ããªã„
- ä»–ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹é …ç›®ã¨ä¸€è²«æ€§ãŒãªã„

### 2. ãƒ˜ãƒƒãƒ€æƒ…å ±ã®æœªæ´»ç”¨
ç¾åœ¨ã¯è¡Œ2ï¼ˆ3è¡Œç›®ï¼‰ã®ãƒ˜ãƒƒãƒ€ãƒ¼åã®ã¿ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ãŒã€è¡Œ0ï¼ˆ1è¡Œç›®ï¼‰ã¨è¡Œ1ï¼ˆ2è¡Œç›®ï¼‰ã®æƒ…å ±ã‚’æ´»ç”¨ã§ãã¦ã„ã¾ã›ã‚“ã€‚

## ğŸ¯ æ”¹è‰¯æ¡ˆã®æ¦‚è¦

### åŸºæœ¬æ–¹é‡
1. **ãƒ˜ãƒƒãƒ€ã®è¤‡æ•°è¡Œã‚’è€ƒæ…®ã—ãŸãƒãƒƒãƒ”ãƒ³ã‚°æ§‹ç¯‰**
   - è¡Œ0ï¼ˆ1è¡Œç›®ï¼‰: ã‚«ãƒ†ã‚´ãƒªåï¼ˆä¾‹ï¼šã€Œç¾åœ¨ãƒ‘ãƒ¯ãƒ¼é …ç›®æ§‹æˆè¦ç´ ã€ã€Œå…±é€š68ã‚¤ãƒ¡ãƒ¼ã‚¸ã€ï¼‰
   - è¡Œ1ï¼ˆ2è¡Œç›®ï¼‰: é …ç›®åï¼ˆä¾‹ï¼šã€ŒèªçŸ¥ã‚ã‚Šã€ã€Œãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã€ï¼‰
   - è¡Œ2ï¼ˆ3è¡Œç›®ï¼‰: è©³ç´°é …ç›®åï¼ˆå®Ÿéš›ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦ä½¿ç”¨ï¼‰

2. **ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸é …ç›®ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°æŠ½å‡º**
   - è¡Œ1ï¼ˆ2è¡Œç›®ï¼‰ã«ã€Œãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã€ã‚’å«ã‚€åˆ—ã‚’æŠ½å‡º
   - å›ºå®šç¯„å›²ã§ã¯ãªãã€å‹•çš„ã«æ¤œå‡º

3. **ä»–ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹é …ç›®ã¨ã®ä¸€è²«æ€§ç¢ºä¿**
   - ã™ã¹ã¦ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹é …ç›®ã‚’åŒæ§˜ã®æ–¹æ³•ã§æŠ½å‡º
   - ãƒ˜ãƒƒãƒ€ã®è¤‡æ•°è¡Œã‚’æ´»ç”¨ã—ãŸæŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯

## ğŸ”§ å®Ÿè£…è©³ç´°

### 1. ãƒ˜ãƒƒãƒ€æ§‹é€ ã®å®šç¾©

```typescript
// src/config/constants.ts

export const EXCEL_STRUCTURE = {
  HEADER_ROW_INDEX: 2,        // 3è¡Œç›®ãŒãƒ˜ãƒƒãƒ€ãƒ¼(0-based: 2)
  CATEGORY_ROW_INDEX: 0,      // 1è¡Œç›®ãŒã‚«ãƒ†ã‚´ãƒª(0-based: 0) â˜…è¿½åŠ 
  ITEM_ROW_INDEX: 1,          // 2è¡Œç›®ãŒé …ç›®å(0-based: 1) â˜…è¿½åŠ 
  DATA_START_INDEX: 3,        // 4è¡Œç›®ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿(0-based: 3)
  BRAND_NAME_COLUMN: 3,       // Dåˆ—ãŒãƒ–ãƒ©ãƒ³ãƒ‰å(0-based: 3)
  // BRAND_IMAGE_START_COLUMN: 41,   // å‰Šé™¤
  // BRAND_IMAGE_END_COLUMN: 175,    // å‰Šé™¤
} as const;

/**
 * ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸é–¢é€£å®šæ•°
 */
export const BRAND_IMAGE = {
  EXCLUDE_KEYWORDS: ['ã‚ã¦ã¯ã¾ã‚‹ã‚‚ã®ã¯ãªã„'],
  // COLUMN_RANGE ã‚’å‰Šé™¤ã—ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã«å¤‰æ›´
  PATTERNS: {
    CATEGORY_KEYWORDS: ['å…±é€š68ã‚¤ãƒ¡ãƒ¼ã‚¸', 'ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸'],  // è¡Œ0ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    ITEM_KEYWORDS: ['ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸'],  // è¡Œ1ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
  },
} as const;
```

### 2. ExcelParserã‚¯ãƒ©ã‚¹ã®æ”¹è‰¯

#### 2.1 ãƒ˜ãƒƒãƒ€æƒ…å ±ã®å–å¾—ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 

```typescript
// src/services/excelParser/ExcelParser.ts

/**
 * ãƒ˜ãƒƒãƒ€æƒ…å ±ã‚’å–å¾—ï¼ˆ3è¡Œåˆ†ï¼‰
 */
private getHeaderInfo(jsonData: any[]): {
  categoryRow: any[];  // è¡Œ0ï¼ˆã‚«ãƒ†ã‚´ãƒªï¼‰
  itemRow: any[];       // è¡Œ1ï¼ˆé …ç›®åï¼‰
  headerRow: any[];     // è¡Œ2ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰
} {
  return {
    categoryRow: jsonData[EXCEL_STRUCTURE.CATEGORY_ROW_INDEX] || [],
    itemRow: jsonData[EXCEL_STRUCTURE.ITEM_ROW_INDEX] || [],
    headerRow: jsonData[EXCEL_STRUCTURE.HEADER_ROW_INDEX] || [],
  };
}
```

#### 2.2 ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸é …ç›®ã®æŠ½å‡ºã‚’ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã«å¤‰æ›´

```typescript
/**
 * ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸é …ç›®ã‚’æŠ½å‡ºï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ç‰ˆï¼‰
 */
private extractBrandImageItems(
  categoryRow: any[],
  itemRow: any[],
  headerRow: any[]
): BrandImageItem[] {
  const items: BrandImageItem[] = [];

  // è¡Œ1ï¼ˆ2è¡Œç›®ï¼‰ã«ã€Œãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã€ã‚’å«ã‚€åˆ—ã‚’æ¤œç´¢
  itemRow.forEach((itemName: any, colIdx: number) => {
    if (!itemName || typeof itemName !== 'string') return;

    const itemStr = itemName.trim();
    
    // ã€Œãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã€ã‚’å«ã‚€ã‹ãƒã‚§ãƒƒã‚¯
    const isBrandImage = BRAND_IMAGE.PATTERNS.ITEM_KEYWORDS.some(keyword =>
      itemStr.includes(keyword)
    );

    if (!isBrandImage) return;

    // é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
    const shouldExclude = BRAND_IMAGE.EXCLUDE_KEYWORDS.some((keyword) =>
      itemStr.includes(keyword)
    );
    if (shouldExclude) return;

    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆè¡Œ2ï¼‰ã‹ã‚‰å®Ÿéš›ã®é …ç›®åã‚’å–å¾—
    const headerName = headerRow[colIdx];
    if (!headerName || typeof headerName !== 'string') return;

    items.push({
      name: headerName.trim(),
      columnIndex: colIdx,
    });
  });

  return items;
}
```

#### 2.3 parseSheetãƒ¡ã‚½ãƒƒãƒ‰ã®ä¿®æ­£

```typescript
private parseSheet(
  worksheet: WorkSheet,
  sheetName: string
): { brands: BrandData; brandImages: Record<string, Record<string, number>> } | null {
  console.log('[ExcelParser] Starting to parse sheet:', sheetName);
  const jsonData = utils.sheet_to_json<any[]>(worksheet, { header: 1 });

  if (!validateExcelStructure(jsonData)) {
    console.warn('[ExcelParser] Invalid Excel structure for sheet:', sheetName);
    return null;
  }

  // ãƒ˜ãƒƒãƒ€æƒ…å ±ã‚’å–å¾—ï¼ˆ3è¡Œåˆ†ï¼‰
  const { categoryRow, itemRow, headerRow } = this.getHeaderInfo(jsonData);

  // ã‚«ãƒ©ãƒ ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’æ§‹ç¯‰ï¼ˆå¾“æ¥é€šã‚Šè¡Œ2ã‚’ä½¿ç”¨ï¼‰
  const columnMapping = this.buildColumnMapping(headerRow);

  // å°‘ãªãã¨ã‚‚1ã¤ã®ãƒ•ã‚¡ãƒãƒ«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå¿…è¦
  if (columnMapping.funnel.FT === undefined) {
    console.warn('[ExcelParser] No funnel metrics found in sheet:', sheetName);
    return null;
  }

  const brands: BrandData = {};
  const brandImages: Record<string, Record<string, number>> = {};
  
  // ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸é …ç›®ã‚’æŠ½å‡ºï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ç‰ˆï¼‰
  const brandImageItems = this.extractBrandImageItems(
    categoryRow,
    itemRow,
    headerRow
  );
  
  console.log('[ExcelParser] Found', brandImageItems.length, 'brand image items');

  for (let i = EXCEL_STRUCTURE.DATA_START_INDEX; i < jsonData.length; i++) {
    const row = jsonData[i];
    const brandName = row[EXCEL_STRUCTURE.BRAND_NAME_COLUMN];

    if (!brandName || typeof brandName !== 'string') continue;

    // ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®èª­ã¿è¾¼ã¿
    const metrics = this.extractMetrics(row, columnMapping);

    // ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿
    const imageValues = this.extractBrandImageValues(row, brandImageItems);
    brandImages[brandName] = imageValues;

    // ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è¨ˆç®—
    const archetypeMetrics = calculateArchetypeMetrics(imageValues);
    metrics.archetypeMetrics = archetypeMetrics;

    brands[brandName] = metrics;
  }

  console.log('[ExcelParser] Parsed', Object.keys(brands).length, 'brands from sheet:', sheetName);
  return { brands, brandImages };
}
```

### 3. å‹å®šç¾©ã®ç¢ºèª

```typescript
// src/types/index.ts

export interface BrandImageItem {
  name: string;           // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆè¡Œ2ï¼‰ã®é …ç›®å
  columnIndex: number;   // åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
}
```

## ğŸ“Š å‹•ä½œç¢ºèª

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

1. **202406ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ207åˆ—ï¼‰**
   - è¡Œ1ã«ã€Œãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã€ã‚’å«ã‚€åˆ—ã‚’æ¤œå‡º
   - åˆ—æ•°ãŒç•°ãªã£ã¦ã‚‚æ­£ã—ãæŠ½å‡ºã•ã‚Œã‚‹

2. **202506ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ195åˆ—ï¼‰**
   - è¡Œ1ã«ã€Œãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã€ã‚’å«ã‚€åˆ—ã‚’æ¤œå‡º
   - åˆ—æ•°ãŒç•°ãªã£ã¦ã‚‚æ­£ã—ãæŠ½å‡ºã•ã‚Œã‚‹

3. **å°†æ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆåˆ—æ•°ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆï¼‰**
   - å›ºå®šç¯„å›²ã«ä¾å­˜ã—ãªã„ãŸã‚ã€è‡ªå‹•çš„ã«å¯¾å¿œå¯èƒ½

## âœ… ãƒ¡ãƒªãƒƒãƒˆ

1. **æŸ”è»Ÿæ€§ã®å‘ä¸Š**
   - åˆ—ä½ç½®ãŒå¤‰ã‚ã£ã¦ã‚‚è‡ªå‹•çš„ã«å¯¾å¿œ
   - ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã«åˆ—æ•°ãŒç•°ãªã£ã¦ã‚‚å•é¡Œãªã—

2. **ä¸€è²«æ€§ã®ç¢ºä¿**
   - ã™ã¹ã¦ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹é …ç›®ã‚’åŒæ§˜ã®æ–¹æ³•ã§æŠ½å‡º
   - ãƒ˜ãƒƒãƒ€ã®è¤‡æ•°è¡Œã‚’æ´»ç”¨ã—ãŸçµ±ä¸€çš„ãªãƒ­ã‚¸ãƒƒã‚¯

3. **ä¿å®ˆæ€§ã®å‘ä¸Š**
   - å›ºå®šç¯„å›²ã®å‰Šé™¤ã«ã‚ˆã‚Šã€è¨­å®šå¤‰æ›´ãŒä¸è¦
   - ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã«ã‚ˆã‚Šã€ã‚ˆã‚Šç›´æ„Ÿçš„ãªæŠ½å‡º

4. **æ‹¡å¼µæ€§ã®å‘ä¸Š**
   - å°†æ¥çš„ã«ä»–ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹é …ç›®ã‚‚åŒæ§˜ã®æ–¹æ³•ã§æŠ½å‡ºå¯èƒ½
   - ãƒ˜ãƒƒãƒ€ã®è¤‡æ•°è¡Œã‚’æ´»ç”¨ã—ãŸé«˜åº¦ãªæŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯ã«å¯¾å¿œ

## ğŸ”„ ç§»è¡Œè¨ˆç”»

### Phase 1: å®Ÿè£…
1. `EXCEL_STRUCTURE`ã«`CATEGORY_ROW_INDEX`ã¨`ITEM_ROW_INDEX`ã‚’è¿½åŠ 
2. `BRAND_IMAGE.COLUMN_RANGE`ã‚’å‰Šé™¤ã—ã€`PATTERNS`ã‚’è¿½åŠ 
3. `getHeaderInfo`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 
4. `extractBrandImageItems`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ç‰ˆã«å¤‰æ›´
5. `parseSheet`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä¿®æ­£

### Phase 2: ãƒ†ã‚¹ãƒˆ
1. æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ202406ã€202506ï¼‰ã§å‹•ä½œç¢ºèª
2. ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸é …ç›®ãŒæ­£ã—ãæŠ½å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
3. éå»æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ã§æ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª

### Phase 3: ãƒªãƒªãƒ¼ã‚¹
1. æ—¢å­˜ã®å‹•ä½œã«å½±éŸ¿ãŒãªã„ã“ã¨ã‚’ç¢ºèª
2. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

## ğŸ“ æ³¨æ„äº‹é …

1. **å¾Œæ–¹äº’æ›æ€§**
   - æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã«ã¯å½±éŸ¿ãªã—
   - ãƒ˜ãƒƒãƒ€æ§‹é€ ãŒåŒã˜ã§ã‚ã‚Œã°ã€è‡ªå‹•çš„ã«å¯¾å¿œ

2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
   - ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸é …ç›®ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®å‡¦ç†ã‚’è¿½åŠ 
   - ãƒ­ã‚°å‡ºåŠ›ã§ãƒ‡ãƒãƒƒã‚°ã—ã‚„ã™ãã™ã‚‹

3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**
   - ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã¯å›ºå®šç¯„å›²ã‚ˆã‚Šè‹¥å¹²é…ã„å¯èƒ½æ€§ãŒã‚ã‚‹ãŒã€å®Ÿç”¨ä¸Šå•é¡Œãªã—
   - å¿…è¦ã«å¿œã˜ã¦æœ€é©åŒ–å¯èƒ½

